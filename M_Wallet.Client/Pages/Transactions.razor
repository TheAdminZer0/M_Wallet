@page "/transactions"
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ReceiptService _receiptService
@inject TransactionService TransactionService
@inject CustomAuthenticationStateProvider AuthStateProvider
@using M_Wallet.Client.Models
@using M_Wallet.Client.Services
@using M_Wallet.Client.Components

<style>
    .fixed-layout-table .mud-table-container > table {
        table-layout: fixed;
        min-width: 1200px;
    }
</style>

<PageTitle>Transactions</PageTitle>

@if (transactions == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <!-- Filters Section -->
    <MudPaper Class="mb-4 pa-1" Elevation="2">
        
        <MudGrid Spacing="1" Class="align-center">
            <MudItem xs="6" sm="4" md="2">
                <MudDatePicker Label="From" 
                               @bind-Date="filterFromDate" 
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               MaxDate="@DateTime.Today" />
            </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudDatePicker Label="To" 
                                   @bind-Date="filterToDate" 
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Clearable="true"
                                   MaxDate="@DateTime.Today" />
                </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudAutocomplete T="Product" 
                                     Label="Product" 
                                     @bind-Value="selectedProductFilter"
                                     SearchFunc="@SearchProducts"
                                     ToStringFunc="@(p => p?.Name)"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="6" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Customer" 
                                     @bind-Value="filterCustomer"
                                     SearchFunc="@SearchCustomers"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="6" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Employee" 
                                     @bind-Value="filterEmployee"
                                     SearchFunc="@SearchEmployees"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="6" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Driver" 
                                     @bind-Value="filterDriver"
                                     SearchFunc="@SearchDrivers"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="2" md="1" Class="d-flex justify-center align-center">
                    <MudTooltip Text="Clear Filters">
                        <MudIconButton Icon="@Icons.Material.Filled.FilterAltOff" 
                                       Color="Color.Error" 
                                       OnClick="ClearFilters"
                                       Size="Size.Medium" />
                    </MudTooltip>
                </MudItem>
                <MudItem xs="6" sm="2" md="1" Class="d-flex justify-center align-center">
                    <MudTooltip Text="@(showProfit ? "Hide Profit" : "Show Profit")">
                        <MudIconButton Icon="@(showProfit ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" 
                                       Color="@(showProfit ? Color.Primary : Color.Default)" 
                                       OnClick="ToggleProfitVisibility"
                                       Size="Size.Medium" />
                    </MudTooltip>
                </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0">
        <MudTabPanel Text="Orders" Icon="@Icons.Material.Filled.Receipt">
            @if (FilteredTransactions.Count() != transactions.Count)
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                    Showing @FilteredTransactions.Count() of @transactions.Count transactions
                </MudAlert>
            }

            <MudPaper Class="pa-2" Elevation="0">
                <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
                    <MudTable Items="@FilteredTransactions" 
                              Hover="true" 
                              Dense="true" 
                              Breakpoint="Breakpoint.None"
                              Filter="new Func<Transaction, bool>(SearchFilter)"
                              @bind-SelectedItem="selectedTransaction"
                              SortLabel="Sort By"
                              RowStyleFunc="RowStyleFunc"
                              OnRowClick="OnRowClick"
                              T="Transaction"
                              Class="fixed-layout-table">
                        <ToolBarContent>
                            <MudSpacer />
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary"
                                       StartIcon="@(expandAll ? Icons.Material.Filled.UnfoldLess : Icons.Material.Filled.UnfoldMore)"
                                       OnClick="ToggleExpandAll"
                                       Class="mr-2">
                                @(expandAll ? "Collapse All" : "Expand All")
                            </MudButton>
                            <MudTextField @bind-Value="searchString" 
                                          Placeholder="Search" 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search" 
                                          IconSize="Size.Medium" 
                                          Class="mt-0"
                                          Immediate="true">
                            </MudTextField>
                        </ToolBarContent>
                        <HeaderContent>
                            @if (IsTransactionColumnVisible("Order ID")) { <MudTh Style="@($"width:{GetColumnWidth("Order ID")}")"><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<Transaction, object>(x => x.Id)">Order ID</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Date")) { <MudTh Style="@($"width:{GetColumnWidth("Date")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.TransactionDate)">Date</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Items")) { <MudTh Style="@($"width:{GetColumnWidth("Items")}")">Items</MudTh> }
                            @if (IsTransactionColumnVisible("Quantity")) { <MudTh Style="@($"width:{GetColumnWidth("Quantity")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Items.Sum(i => i.Quantity))">Quantity</MudTableSortLabel></MudTh> }
                            @if (showProfit)
                            {
                                <MudTh Style="@($"width:{GetColumnWidth("Cost")}")">Cost (LD)</MudTh>
                                <MudTh Style="@($"width:{GetColumnWidth("Profit")}")">Profit (LD)</MudTh>
                            }
                            @if (IsTransactionColumnVisible("Total")) { <MudTh Style="@($"width:{GetColumnWidth("Total")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.TotalAmount)">Total (LD)</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Discount")) { <MudTh Style="@($"width:{GetColumnWidth("Discount")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Discount)">Discount</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Payment")) { <MudTh Style="@($"width:{GetColumnWidth("Payment")}")">Payment</MudTh> }
                            @if (IsTransactionColumnVisible("Delivery")) { <MudTh Style="@($"width:{GetColumnWidth("Delivery")}")">Delivery</MudTh> }
                            @if (IsTransactionColumnVisible("Driver")) { <MudTh Style="@($"width:{GetColumnWidth("Driver")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Driver?.Name ?? string.Empty)">Driver</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Customer")) { <MudTh Style="@($"width:{GetColumnWidth("Customer")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.CustomerName ?? string.Empty)">Customer</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Note")) { <MudTh Style="@($"width:{GetColumnWidth("Note")}")">Note</MudTh> }
                            @if (IsTransactionColumnVisible("Employee")) { <MudTh Style="@($"width:{GetColumnWidth("Employee")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.EmployeeName)">Employee</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Actions")) { <MudTh Style="@($"width:{GetColumnWidth("Actions")}")">Actions</MudTh> }
                        </HeaderContent>
                        <RowTemplate>
                            @if (IsTransactionColumnVisible("Order ID")) {
                                <MudTd DataLabel="Order ID">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@(expandedTransactions.Contains(context.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                                 Size="Size.Small" 
                                                 Class="mr-2"/>
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" OnClick="@((e) => ShowPaymentHistory(context))" Style="cursor: pointer;">#@context.Id</MudChip>
                                    </div>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Date")) { <MudTd DataLabel="Date" Style="white-space: nowrap;">@context.TransactionDate.ToLocalTime().ToString("yyyy/MM/dd hh:mm tt")</MudTd> }
                            @if (IsTransactionColumnVisible("Items")) { <MudTd DataLabel="Items">@string.Join(", ", context.Items.Select(i => i.Product?.Name ?? "Unknown").Distinct())</MudTd> }
                            @if (IsTransactionColumnVisible("Quantity")) { <MudTd DataLabel="Quantity">@context.Items.Sum(i => i.Quantity)</MudTd> }
                            @if (showProfit)
                            {
                                <MudTd DataLabel="Cost">
                                    @{
                                        var cost = CalculateOrderCost(context);
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Info">
                                        @cost.ToString("F2")
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Profit">
                                    @{
                                        var profit = CalculateOrderProfit(context);
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="@(profit > 0 ? Color.Success : Color.Error)">
                                        @profit.ToString("F2")
                                    </MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Total")) {
                                <MudTd DataLabel="Total">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Success">
                                        @context.TotalAmount.ToString("F2")
                                    </MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Discount")) {
                                <MudTd DataLabel="Discount">
                                    @if (context.Discount > 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Error">
                                            -@context.Discount.ToString("F2")
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                    }
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Payment Status")) {
                                <MudTd DataLabel="Payment Status">
                                    @{
                                        var paid = context.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0;
                                        var status = "Unpaid";
                                        var color = Color.Error;
                                        
                                        if (context.Status == TransactionStatus.Canceled)
                                        {
                                            status = "Canceled";
                                            color = Color.Default;
                                        }
                                        else if (paid >= context.TotalAmount - 0.01m) // Tolerance for float math
                                        { 
                                            status = "Paid"; 
                                            color = Color.Success; 
                                        }
                                        else if (paid > 0) 
                                        { 
                                            status = "Partial"; 
                                            color = Color.Warning; 
                                        }
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@color" OnClick="@((e) => (status == "Paid" || status == "Canceled") ? null : OpenPaymentDialog(context))" Style="@((status == "Paid" || status == "Canceled") ? "" : "cursor: pointer;")">@status</MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Delivery Status")) {
                                <MudTd DataLabel="Delivery Status">
                                    @if (context.IsDelivery)
                                    {
                                        var isFinalized = context.Status == TransactionStatus.Completed || context.Status == TransactionStatus.Canceled;
                                        <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" 
                                                       Color="@GetStatusColor(context.Status)" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => isFinalized ? Task.CompletedTask : OpenStatusDialog(context))"
                                                       Ripple="@(!isFinalized)"
                                                       Style="@(isFinalized ? "cursor: default;" : "")"
                                                       Title="@(isFinalized ? $"{context.Status} (Finalized)" : "Update Status")" />
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-center" style="width: 100%;">
                                            <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                        </div>
                                    }
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Driver")) { <MudTd DataLabel="Driver">@(context.Driver?.Name ?? "-")</MudTd> }
                            @if (IsTransactionColumnVisible("Customer")) { <MudTd DataLabel="Customer">@(context.CustomerName ?? "Walk-in")</MudTd> }
                            @if (IsTransactionColumnVisible("Note")) { 
                                <MudTd DataLabel="Note">
                                    <div @onclick="@(() => EditNote(context))" style="cursor: pointer; display: flex; align-items: center;">
                                        @if (!string.IsNullOrEmpty(context.Note))
                                        {
                                            <MudText Typo="Typo.body2" Style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                @context.Note
                                            </MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="ml-1" Color="Color.Default" Style="opacity: 0.5;" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.AddComment" Size="Size.Small" Color="Color.Default" Style="opacity: 0.3;" />
                                        }
                                    </div>
                                </MudTd> 
                            }
                            @if (IsTransactionColumnVisible("Employee")) { <MudTd DataLabel="Employee">@context.EmployeeName</MudTd> }
                            @if (IsTransactionColumnVisible("Actions")) {
                                <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                                    <div class="d-flex align-center">
                                        <MudMenu Icon="@Icons.Material.Filled.Print" Color="Color.Info" Size="Size.Small" Dense="true">
                                            <MudMenuItem OnClick="@(() => PrintReceipt(context))">Print Receipt (Thermal)</MudMenuItem>
                                            <MudMenuItem OnClick="@(() => PrintInvoice(context))">Print Invoice (A4)</MudMenuItem>
                                        </MudMenu>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Color="Color.Error" 
                                                       Size="Size.Small" 
                                                       OnClick="@(() => DeleteTransaction(context))" />
                                    </div>
                                </MudTd>
                            }
                        </RowTemplate>
                        <ChildRowContent Context="trans">
                            @if (expandedTransactions.Contains(trans.Id))
                            {
                                <MudTr>
                                    <td colspan="20" class="pa-0">
                                        <MudCard Elevation="0" Class="pa-0 rounded-0" Style="position: relative; background-color: var(--mud-palette-background-grey); border-bottom: 1px solid var(--mud-palette-lines-default);">
                                            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: var(--mud-palette-primary); z-index: 1;"></div>
                                            <div class="d-flex flex-column">
                                                @foreach (var item in trans.Items)
                                                {
                                                    <div class="d-flex flex-row align-center" style="border-bottom: 1px solid var(--mud-palette-divider);">
                                                        @if (IsTransactionColumnVisible("Order ID")) { <div style="@($"width:{GetColumnWidth("Order ID")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Date")) { <div style="@($"width:{GetColumnWidth("Date")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Items")) {
                                                            <div class="py-1 px-4" style="@($"width:{GetColumnWidth("Items")}")">
                                                                <div class="d-flex align-center">
                                                                    <MudText Typo="Typo.caption" Class="mr-2" Color="Color.Default">(@item.UnitPrice.ToString("F2"))</MudText>
                                                                    @if (item.Product != null)
                                                                    {
                                                                        <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                                                       Color="Color.Default"
                                                                                       Size="Size.Small"
                                                                                       Class="mr-2"
                                                                                       OnClick="@(() => ShowProductDetails(item.Product!))" />
                                                                    }
                                                                    <MudText>@item.Product?.Name</MudText>
                                                                </div>
                                                            </div>
                                                        }
                                                        @if (IsTransactionColumnVisible("Quantity")) { <div class="py-1 px-4" style="@($"width:{GetColumnWidth("Quantity")}")">@item.Quantity</div> }
                                                        @if (showProfit)
                                                        {
                                                            <div class="py-1 px-4" style="@($"width:{GetColumnWidth("Cost")}")">
                                                                <MudText Typo="Typo.body2" Color="Color.Info">
                                                                    @(((item.UnitCost > 0 ? item.UnitCost : item.Product?.CostPrice ?? 0) * item.Quantity).ToString("F2"))
                                                                </MudText>
                                                            </div>
                                                            <div class="py-1 px-4" style="@($"width:{GetColumnWidth("Profit")}")">
                                                                @{
                                                                    var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
                                                                    var itemProfit = (item.UnitPrice - cost) * item.Quantity;
                                                                }
                                                                <MudText Typo="Typo.body2" Color="@(itemProfit > 0 ? Color.Success : Color.Error)">
                                                                    <b>@itemProfit.ToString("F2")</b>
                                                                </MudText>
                                                            </div>
                                                        }
                                                        @if (IsTransactionColumnVisible("Total")) {
                                                            <div class="py-1 px-4" style="@($"width:{GetColumnWidth("Total")}")">
                                                                <b>@item.Subtotal.ToString("F2")</b>
                                                            </div>
                                                        }
                                                        @if (IsTransactionColumnVisible("Discount")) { <div style="@($"width:{GetColumnWidth("Discount")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Payment Status")) { <div style="@($"width:{GetColumnWidth("Payment Status")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Delivery Status")) { <div style="@($"width:{GetColumnWidth("Delivery Status")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Driver")) { <div style="@($"width:{GetColumnWidth("Driver")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Customer")) { <div style="@($"width:{GetColumnWidth("Customer")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Note")) { <div style="@($"width:{GetColumnWidth("Note")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Employee")) { <div style="@($"width:{GetColumnWidth("Employee")}")"></div> }
                                                        @if (IsTransactionColumnVisible("Actions")) { <div style="@($"width:{GetColumnWidth("Actions")}")"></div> }
                                                    </div>
                                                }
                                            </div>
                                            @if (trans.Discount > 0)
                                            {
                                                <div class="d-flex justify-end mt-2 gap-4 px-4">
                                                     <MudText Typo="Typo.body2"><b>Subtotal:</b> @((trans.TotalAmount + trans.Discount).ToString("F2"))</MudText>
                                                     <MudText Typo="Typo.body2" Color="Color.Error"><b>Discount:</b> -@trans.Discount.ToString("F2")</MudText>
                                                     <MudText Typo="Typo.body2" Color="Color.Primary"><b>Total:</b> @trans.TotalAmount.ToString("F2")</MudText>
                                                </div>
                                            }
                                        </MudCard>
                                    </td>
                                </MudTr>
                            }
                        </ChildRowContent>
                        <PagerContent>
                            <div class="d-flex align-center justify-space-between px-4 py-2">
                                <TableColumnToggle Columns="@_transactionColumns" ColumnsChanged="StateHasChanged" TableName="Transactions" />
                                <MudTablePager />
                            </div>
                        </PagerContent>
                    </MudTable>
                </div>
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="Payments" Icon="@Icons.Material.Filled.History">
            @if (payments == null)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                <MudTable Items="@FilteredPayments" Hover="true" Dense="true" Breakpoint="Breakpoint.None">
                    <ToolBarContent>
                        <MudSpacer />
                        <MudTextField @bind-Value="paymentSearchString" 
                                      Placeholder="Search Payments" 
                                      Adornment="Adornment.Start" 
                                      AdornmentIcon="@Icons.Material.Filled.Search" 
                                      IconSize="Size.Medium" 
                                      Class="mt-0"
                                      Immediate="true">
                        </MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (IsPaymentColumnVisible("Payment ID")) { <MudTh>Payment ID</MudTh> }
                        @if (IsPaymentColumnVisible("Realized Profit")) { <MudTh>Realized Profit</MudTh> }
                        @if (IsPaymentColumnVisible("Date")) { <MudTh>Date</MudTh> }
                        @if (IsPaymentColumnVisible("Method")) { <MudTh Class="d-none d-sm-table-cell">Method</MudTh> }
                        @if (IsPaymentColumnVisible("Reference")) { <MudTh Class="d-none d-sm-table-cell">Reference</MudTh> }
                        @if (IsPaymentColumnVisible("Amount")) { <MudTh>Amount</MudTh> }
                        @if (IsPaymentColumnVisible("Allocations")) { <MudTh>Allocations</MudTh> }
                        @if (IsPaymentColumnVisible("Actions")) { <MudTh>Actions</MudTh> }
                    </HeaderContent>
                    <RowTemplate>
                        @if (IsPaymentColumnVisible("Payment ID")) { <MudTd DataLabel="Payment ID">#@context.Id</MudTd> }
                        @if (IsPaymentColumnVisible("Realized Profit")) {
                            <MudTd DataLabel="Realized Profit">
                                @{
                                    var realizedProfit = GetRealizedProfit(context);
                                }
                                @if (realizedProfit != 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@(realizedProfit > 0 ? Color.Success : Color.Error)">
                                        LD @realizedProfit.ToString("F2")
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                }
                            </MudTd>
                        }
                        @if (IsPaymentColumnVisible("Date")) { <MudTd DataLabel="Date" Style="white-space: nowrap;">@context.PaymentDate.ToLocalTime().ToString("yyyy/MM/dd hh:mm tt")</MudTd> }
                        @if (IsPaymentColumnVisible("Method")) { <MudTd DataLabel="Method" Class="d-none d-sm-table-cell">@context.PaymentMethod</MudTd> }
                        @if (IsPaymentColumnVisible("Reference")) { <MudTd DataLabel="Reference" Class="d-none d-sm-table-cell">@context.Reference</MudTd> }
                        @if (IsPaymentColumnVisible("Amount")) {
                            <MudTd DataLabel="Amount">
                                <MudText Color="Color.Success" Class="font-weight-bold">
                                    LD @context.Amount.ToString("F2")
                                </MudText>
                            </MudTd>
                        }
                        @if (IsPaymentColumnVisible("Allocations")) {
                            <MudTd DataLabel="Allocations">
                                <MudText Typo="Typo.body2">
                                    @string.Join(", ", context.Allocations.Select(a => $"#{a.TransactionId}: {a.Amount:F2}"))
                                </MudText>
                            </MudTd>
                        }
                        @if (IsPaymentColumnVisible("Actions")) {
                            <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                               Color="Color.Error" 
                                               Size="Size.Small" 
                                               OnClick="@(() => DeletePayment(context))" />
                            </MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_paymentColumns" ColumnsChanged="StateHasChanged" TableName="TransactionPayments" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            }
        </MudTabPanel>

        <MudTabPanel Text="Outstanding Invoices" Icon="@Icons.Material.Filled.PendingActions">
            @{
                var unpaidTransactions = FilteredTransactions.Where(t => (t.TotalAmount - (t.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0)) > 0.01m).ToList();
            }
            @if (!unpaidTransactions.Any())
            {
                <MudAlert Severity="Severity.Success">No outstanding invoices matching filters!</MudAlert>
            }
            else
            {
                <MudTable Items="@unpaidTransactions" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Transaction, bool>(SearchFilter)">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Unpaid Invoices</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (IsInvoiceColumnVisible("Order ID")) { <MudTh>Order ID</MudTh> }
                        @if (IsInvoiceColumnVisible("Date")) { <MudTh>Date</MudTh> }
                        @if (IsInvoiceColumnVisible("Customer")) { <MudTh>Customer</MudTh> }
                        @if (IsInvoiceColumnVisible("Total")) { <MudTh>Total</MudTh> }
                        @if (IsInvoiceColumnVisible("Paid")) { <MudTh>Paid</MudTh> }
                        @if (IsInvoiceColumnVisible("Balance")) { <MudTh>Balance</MudTh> }
                        @if (IsInvoiceColumnVisible("Action")) { <MudTh>Action</MudTh> }
                    </HeaderContent>
                    <RowTemplate>
                        @if (IsInvoiceColumnVisible("Order ID")) { <MudTd DataLabel="Order ID">#@context.Id</MudTd> }
                        @if (IsInvoiceColumnVisible("Date")) { <MudTd DataLabel="Date" Style="white-space: nowrap;">@context.TransactionDate.ToLocalTime().ToString("yyyy/MM/dd")</MudTd> }
                        @if (IsInvoiceColumnVisible("Customer")) { <MudTd DataLabel="Customer">@(context.CustomerName ?? "Walk-in")</MudTd> }
                        @if (IsInvoiceColumnVisible("Total")) { <MudTd DataLabel="Total">LD @context.TotalAmount.ToString("F2")</MudTd> }
                        @if (IsInvoiceColumnVisible("Paid")) { <MudTd DataLabel="Paid">LD @(context.PaymentAllocations?.Sum(pa => pa.Amount).ToString("F2") ?? "0.00")</MudTd> }
                        @if (IsInvoiceColumnVisible("Balance")) {
                            <MudTd DataLabel="Balance">
                                <MudText Color="Color.Error" Class="font-weight-bold">
                                    LD @((context.TotalAmount - (context.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0)).ToString("F2"))
                                </MudText>
                            </MudTd>
                        }
                        @if (IsInvoiceColumnVisible("Action")) {
                            <MudTd DataLabel="Action" Style="white-space: nowrap;">
                                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="@(() => OpenPaymentDialog(context))">
                                    Pay
                                </MudButton>
                            </MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_invoiceColumns" ColumnsChanged="StateHasChanged" TableName="TransactionInvoices" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    private List<Transaction>? transactions;
    private Dictionary<int, Transaction> _transactionsById = new();
    private List<Payment>? payments;
    private Dictionary<int, List<Payment>> _paymentsByTransactionId = new();
    private Transaction? selectedTransaction;
    private string searchString = "";
    private string paymentSearchString = "";
    private HashSet<int> expandedTransactions = new();
    private bool expandAll = false;
    private bool showProfit = false;

    private List<ColumnDefinition> _transactionColumns = new()
    {
        new() { Title = "Order ID", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Items", IsVisible = true },
        new() { Title = "Quantity", IsVisible = true },
        new() { Title = "Total", IsVisible = true },
        new() { Title = "Discount", IsVisible = true },
        new() { Title = "Payment Status", IsVisible = true },
        new() { Title = "Delivery Status", IsVisible = true },
        new() { Title = "Driver", IsVisible = true },
        new() { Title = "Customer", IsVisible = true },
        new() { Title = "Note", IsVisible = true },
        new() { Title = "Employee", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _paymentColumns = new()
    {
        new() { Title = "Payment ID", IsVisible = true },
        new() { Title = "Realized Profit", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Method", IsVisible = true },
        new() { Title = "Reference", IsVisible = true },
        new() { Title = "Amount", IsVisible = true },
        new() { Title = "Allocations", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _invoiceColumns = new()
    {
        new() { Title = "Order ID", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Customer", IsVisible = true },
        new() { Title = "Total", IsVisible = true },
        new() { Title = "Paid", IsVisible = true },
        new() { Title = "Balance", IsVisible = true },
        new() { Title = "Action", IsVisible = true }
    };

    private bool IsTransactionColumnVisible(string title) => _transactionColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;
    private bool IsPaymentColumnVisible(string title) => _paymentColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;
    private bool IsInvoiceColumnVisible(string title) => _invoiceColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;


    // Filter variables
    private DateTime? filterFromDate;
    private DateTime? filterToDate;
    private Product? selectedProductFilter;
    private string? filterCustomer;
    private string? filterEmployee;
    private string? filterDriver;

    private IEnumerable<Transaction> FilteredTransactions
    {
        get
        {
            if (transactions == null) return Enumerable.Empty<Transaction>();

            var filtered = transactions.AsEnumerable();

            // Date range filter
            if (filterFromDate.HasValue)
            {
                filtered = filtered.Where(t => t.TransactionDate.Date >= filterFromDate.Value.Date);
            }
            if (filterToDate.HasValue)
            {
                filtered = filtered.Where(t => t.TransactionDate.Date <= filterToDate.Value.Date);
            }

            // Product filter
            if (selectedProductFilter != null)
            {
                filtered = filtered.Where(t => t.Items.Any(i => i.ProductId == selectedProductFilter.Id));
            }

            // Customer filter
            if (!string.IsNullOrWhiteSpace(filterCustomer))
            {
                if (filterCustomer == "Walk-in")
                {
                    filtered = filtered.Where(t => string.IsNullOrWhiteSpace(t.CustomerName));
                }
                else
                {
                    filtered = filtered.Where(t => t.CustomerName == filterCustomer);
                }
            }

            // Employee filter
            if (!string.IsNullOrWhiteSpace(filterEmployee))
            {
                filtered = filtered.Where(t => t.EmployeeName == filterEmployee);
            }

            // Driver filter
            if (!string.IsNullOrWhiteSpace(filterDriver))
            {
                filtered = filtered.Where(t => (t.Driver?.Name ?? "") == filterDriver);
            }

            return filtered;
        }
    }

    private IEnumerable<Payment> FilteredPayments
    {
        get
        {
            if (payments == null) return Enumerable.Empty<Payment>();

            var filtered = payments.AsEnumerable();

            // Date range filter
            if (filterFromDate.HasValue)
            {
                filtered = filtered.Where(p => p.PaymentDate.Date >= filterFromDate.Value.Date);
            }
            if (filterToDate.HasValue)
            {
                filtered = filtered.Where(p => p.PaymentDate.Date <= filterToDate.Value.Date);
            }

            // Customer filter
            if (!string.IsNullOrWhiteSpace(filterCustomer))
            {
                if (filterCustomer == "Walk-in")
                {
                    filtered = filtered.Where(p => string.IsNullOrWhiteSpace(p.CustomerName));
                }
                else
                {
                    filtered = filtered.Where(p => p.CustomerName == filterCustomer);
                }
            }

            // Search filter
            if (!string.IsNullOrWhiteSpace(paymentSearchString))
            {
                filtered = filtered.Where(p => 
                    p.Id.ToString().Contains(paymentSearchString) ||
                    (p.CustomerName ?? "Walk-in").Contains(paymentSearchString, StringComparison.OrdinalIgnoreCase) ||
                    (p.Reference ?? "").Contains(paymentSearchString, StringComparison.OrdinalIgnoreCase) ||
                    p.Amount.ToString().Contains(paymentSearchString) ||
                    p.Allocations.Any(a => a.TransactionId.ToString().Contains(paymentSearchString))
                );
            }

            return filtered.OrderByDescending(p => p.PaymentDate);
        }
    }

    private bool SearchFilter(Transaction transaction)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (transaction.Id.ToString().Contains(searchString))
            return true;
        if (transaction.EmployeeName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if ((transaction.CustomerName ?? "Walk-in").Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if ((transaction.Note ?? "").Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (transaction.TotalAmount.ToString().Contains(searchString))
            return true;
        if (transaction.Items.Any(i => i.Product?.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false))
            return true;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await TransactionService.RefreshDataAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            transactions = await TransactionService.GetTransactionsAsync();
            payments = await TransactionService.GetPaymentsAsync();
            
            // Index transactions for fast lookup
            if (transactions != null)
            {
                _transactionsById = transactions.ToDictionary(t => t.Id);
            }

            // Pre-calculate payment lookup for performance
            _paymentsByTransactionId.Clear();
            if (payments != null)
            {
                foreach (var p in payments)
                {
                    if (p.Allocations == null) continue;
                    foreach (var a in p.Allocations)
                    {
                        if (!_paymentsByTransactionId.ContainsKey(a.TransactionId))
                        {
                            _paymentsByTransactionId[a.TransactionId] = new List<Payment>();
                        }
                        _paymentsByTransactionId[a.TransactionId].Add(p);
                    }
                }
                
                // Sort by date for correct cumulative calculation
                foreach (var list in _paymentsByTransactionId.Values)
                {
                    list.Sort((a, b) => a.PaymentDate.CompareTo(b.PaymentDate));
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private string RowStyleFunc(Transaction transaction, int index)
    {
        if (expandedTransactions.Contains(transaction.Id))
        {
            return "background-color: rgba(var(--mud-palette-primary-rgb), 0.08);";
        }
        return string.Empty;
    }

    private void OnRowClick(TableRowClickEventArgs<Transaction> args)
    {
        if (args.Item != null)
        {
            ToggleExpanded(args.Item.Id);
        }
    }

    private void ToggleExpanded(int transactionId)
    {
        if (expandedTransactions.Contains(transactionId))
        {
            expandedTransactions.Remove(transactionId);
        }
        else
        {
            expandedTransactions.Add(transactionId);
        }
    }

    private void ToggleExpandAll()
    {
        expandAll = !expandAll;
        
        if (expandAll)
        {
            // Expand all visible transactions
            if (transactions != null)
            {
                expandedTransactions = FilteredTransactions.Select(t => t.Id).ToHashSet();
            }
        }
        else
        {
            // Collapse all transactions
            expandedTransactions.Clear();
        }
    }

    private void ClearFilters()
    {
        filterFromDate = null;
        filterToDate = null;
        selectedProductFilter = null;
        filterCustomer = null;
        filterEmployee = null;
        filterDriver = null;
    }

    private void ToggleProfitVisibility()
    {
        showProfit = !showProfit;
    }

    private decimal CalculateOrderCost(Transaction transaction)
    {
        return transaction.Items.Sum(item => 
            (item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0)) * item.Quantity);
    }

    private decimal CalculateOrderProfit(Transaction transaction)
    {
        if (transaction.Items == null) return 0;
        var grossProfit = transaction.Items.Sum(item =>
        {
            var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
            return (item.UnitPrice - cost) * item.Quantity;
        });
        return grossProfit - transaction.Discount;
    }

    private Task<IEnumerable<Product>> SearchProducts(string value, CancellationToken token)
    {
        var products = GetUniqueProducts();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? products 
            : products.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private Task<IEnumerable<string>> SearchCustomers(string value, CancellationToken token)
    {
        var customers = GetUniqueCustomers();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? customers 
            : customers.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private List<Product> GetUniqueProducts()
    {
        if (transactions == null) return new();

        return transactions
            .SelectMany(t => t.Items)
            .Where(i => i.Product != null)
            .Select(i => i.Product!)
            .GroupBy(p => p.Id)
            .Select(g => g.First())
            .OrderBy(p => p.Name)
            .ToList();
    }

    private List<string> GetUniqueCustomers()
    {
        if (transactions == null) return new();

        return transactions
            .Select(t => string.IsNullOrWhiteSpace(t.CustomerName) ? "Walk-in" : t.CustomerName)
            .Distinct()
            .OrderBy(c => c)
            .ToList();
    }

    private List<string> GetUniqueEmployees()
    {
        if (transactions == null) return new();

        return transactions
            .Select(t => t.EmployeeName)
            .Distinct()
            .OrderBy(e => e)
            .ToList();
    }

    private Task<IEnumerable<string>> SearchEmployees(string value, CancellationToken token)
    {
        var employees = GetUniqueEmployees();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? employees 
            : employees.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private List<string> GetUniqueDrivers()
    {
        if (transactions == null) return new();

        return transactions
            .Where(t => t.Driver != null)
            .Select(t => t.Driver!.Name)
            .Distinct()
            .OrderBy(d => d)
            .ToList();
    }

    private Task<IEnumerable<string>> SearchDrivers(string value, CancellationToken token)
    {
        var drivers = GetUniqueDrivers();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? drivers 
            : drivers.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task OpenPaymentDialog(Transaction transaction)
    {
        var paid = transaction.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0;
        var balance = transaction.TotalAmount - paid;

        var parameters = new DialogParameters 
        { 
            ["TransactionId"] = transaction.Id,
            ["BalanceDue"] = balance,
            ["CustomerName"] = transaction.CustomerName
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PaymentDialog>("Process Payment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await TransactionService.RefreshDataAsync();
            await LoadData();
        }
    }

    private async Task ShowPaymentHistory(Transaction transaction)
    {
        var parameters = new DialogParameters { ["Transaction"] = transaction };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PaymentHistoryDialog>($"Payment History - Order #{transaction.Id}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await TransactionService.RefreshDataAsync();
            await LoadData();
        }
    }

    private async Task ShowProductDetails(Product product)
    {
        var parameters = new DialogParameters { ["Product"] = product };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<ProductDetailsDialog>(product.Name, parameters, options);
    }

    private async Task PrintReceipt(Transaction transaction)
    {
        var html = _receiptService.GenerateReceiptHtml(transaction);
        await JSRuntime.InvokeVoidAsync("printer.printHtml", html);
    }

    private async Task PrintInvoice(Transaction transaction)
    {
        var html = _receiptService.GenerateInvoiceHtml(transaction);
        await JSRuntime.InvokeVoidAsync("printer.printHtml", html);
    }

    private async Task EditNote(Transaction transaction)
    {
        var parameters = new DialogParameters<M_Wallet.Client.Components.NoteDialog>
        {
            { x => x.Note, transaction.Note ?? "" }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<M_Wallet.Client.Components.NoteDialog>("Edit Note", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newNote = result.Data as string;
            if (transaction.Note != newNote)
            {
                transaction.Note = newNote;
                try
                {
                    var response = await Http.PutAsJsonAsync($"api/transactions/{transaction.Id}", transaction);
                    if (response.IsSuccessStatusCode)
                    {
                        Snackbar.Add("Note updated", Severity.Success);
                    }
                    else
                    {
                        Snackbar.Add("Failed to update note", Severity.Error);
                        await LoadData();
                    }
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Error: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task DeleteTransaction(Transaction transaction)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Transaction", 
            $"Are you sure you want to delete Order #{transaction.Id}? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var currentUser = await AuthStateProvider.GetCurrentUserAsync();
                var employeeName = currentUser?.Name ?? "Unknown";
                var response = await Http.DeleteAsync($"api/transactions/{transaction.Id}?employeeName={Uri.EscapeDataString(employeeName)}");
                
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Transaction deleted", Severity.Success);
                    await TransactionService.RefreshDataAsync();
                    await LoadData();
                }
                else
                {
                    Snackbar.Add("Failed to delete transaction", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeletePayment(Payment payment)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Payment", 
            $"Are you sure you want to delete Payment #{payment.Id} (LD {payment.Amount:F2})? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/payments/{payment.Id}");
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Payment deleted", Severity.Success);
                    await TransactionService.RefreshDataAsync();
                    await LoadData();
                }
                else
                {
                    Snackbar.Add("Failed to delete payment", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private decimal GetRealizedProfit(Payment payment)
    {
        decimal totalRealizedProfit = 0;
        if (payment.Allocations == null || !payment.Allocations.Any()) return 0;

        foreach (var allocation in payment.Allocations)
        {
            // Look up transaction from our local index instead of relying on nested object
            if (!_transactionsById.TryGetValue(allocation.TransactionId, out var transaction))
            {
                continue;
            }
            
            if (transaction.Items == null || !transaction.Items.Any()) continue;

            // Find all payments for this transaction using the pre-calculated lookup
            if (!_paymentsByTransactionId.TryGetValue(transaction.Id, out var allPaymentsForTransaction))
            {
                continue;
            }

            // Calculate cumulative paid amount up to and including this payment
            decimal cumulative = 0;
            bool isCompletingPayment = false;

            foreach (var p in allPaymentsForTransaction)
            {
                var allocationAmount = p.Allocations.FirstOrDefault(a => a.TransactionId == transaction.Id)?.Amount ?? 0;
                cumulative += allocationAmount;

                if (p.Id == payment.Id)
                {
                    // This payment completes the transaction if cumulative reaches total
                    if (cumulative >= transaction.TotalAmount - 0.01m)
                    {
                        isCompletingPayment = true;
                    }
                    break;
                }
            }

            if (isCompletingPayment)
            {
                totalRealizedProfit += CalculateOrderProfit(transaction);
            }
        }
        return totalRealizedProfit;
    }

    private Color GetStatusColor(TransactionStatus status)
    {
        return status switch
        {
            TransactionStatus.Completed => Color.Success,
            TransactionStatus.Pending => Color.Warning,
            TransactionStatus.Canceled => Color.Default,
            _ => Color.Default
        };
    }

    private async Task UpdateStatus(Transaction transaction, TransactionStatus newStatus)
    {
        if (transaction.Status == newStatus) return;

        try
        {
            var response = await Http.PutAsJsonAsync($"api/transactions/{transaction.Id}/status", newStatus);
            if (response.IsSuccessStatusCode)
            {
                transaction.Status = newStatus;
                Snackbar.Add($"Status updated to {newStatus}", Severity.Success);
                await TransactionService.RefreshDataAsync(); // Refresh to update stock if needed
            }
            else
            {
                Snackbar.Add("Failed to update status", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenStatusDialog(Transaction transaction)
    {
        var parameters = new DialogParameters { ["Transaction"] = transaction };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StatusUpdateDialog>($"Delivery Status #{transaction.Id}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is StatusUpdateDialog.StatusUpdateResult updateResult)
        {
            // 1. Update Status
            if (transaction.Status != updateResult.Status)
            {
                await UpdateStatus(transaction, updateResult.Status);
            }

            // 2. Process Payment if requested
            if (updateResult.AddPayment && updateResult.PaymentAmount > 0)
            {
                await ProcessPayment(transaction, updateResult.PaymentAmount, updateResult.PaymentMethod);
            }
        }
    }

    private async Task ProcessPayment(Transaction transaction, decimal amount, string method)
    {
        try
        {
            var currentUser = await AuthStateProvider.GetCurrentUserAsync();
            var payment = new Payment
            {
                PaymentDate = DateTime.UtcNow,
                Amount = amount,
                PaymentMethod = method,
                CustomerName = transaction.CustomerName,
                EmployeeName = currentUser?.Name ?? "Unknown",
                PersonId = transaction.PersonId,
                Allocations = new List<PaymentAllocation>
                {
                    new PaymentAllocation
                    {
                        TransactionId = transaction.Id,
                        Amount = amount
                    }
                }
            };
            
            var response = await Http.PostAsJsonAsync("api/payments", payment);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Payment recorded", Severity.Success);
                await TransactionService.RefreshDataAsync();
                await LoadData();
            }
            else
            {
                Snackbar.Add("Failed to record payment", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error recording payment: {ex.Message}", Severity.Error);
        }
    }

    private string GetColumnWidth(string columnName)
    {
        return columnName switch
        {
            "Order ID" => "120px",
            "Date" => "15%",
            "Items" => "20%",
            "Quantity" => "6%",
            "Cost" => "8%",
            "Profit" => "8%",
            "Total" => "12%",
            "Discount" => "8%",
            "Payment" => "8%",
            "Delivery" => "8%",
            "Driver" => "10%",
            "Customer" => "10%",
            "Note" => "10%",
            "Employee" => "8%",
            "Actions" => "5%",
            _ => "auto"
        };
    }
}
