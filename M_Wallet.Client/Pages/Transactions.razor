@page "/transactions"
@inject HttpClient Http
@inject NotificationService Notify
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ReceiptService _receiptService
@inject TransactionService TransactionService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<style>
    .fixed-layout-table .mud-table-container > table {
        table-layout: fixed;
        min-width: 1200px;
    }
</style>

<PageTitle>Transactions</PageTitle>

@* Filters and top-of-page load state *@

@if (transactions == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <!-- Filters Section - Collapsible -->
    <MudPaper Class="mb-2 pa-2" Elevation="2" Style="overflow: visible;">
        <MudGrid Spacing="1" Class="align-center">
            @if (filtersExpanded)
            {
                <MudItem xs="6" sm="4" md="2">
                    <MudDatePicker Label="From" 
                                   @bind-Date="filterFromDate" 
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Clearable="true"
                                   MaxDate="@DateTime.Today" />
                </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudDatePicker Label="To" 
                                   @bind-Date="filterToDate" 
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Clearable="true"
                                   MaxDate="@DateTime.Today" />
                </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudAutocomplete T="Product" 
                                     Label="Product" 
                                     @bind-Value="selectedProductFilter"
                                     SearchFunc="@SearchProducts"
                                     ToStringFunc="@(p => p?.Name)"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Customer" 
                                     @bind-Value="filterCustomer"
                                     SearchFunc="@SearchCustomers"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Employee" 
                                     @bind-Value="filterEmployee"
                                     SearchFunc="@SearchEmployees"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="5" sm="3" md="1">
                    <MudAutocomplete T="string" 
                                     Label="Driver" 
                                     @bind-Value="filterDriver"
                                     SearchFunc="@SearchDrivers"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="1" sm="1" md="1" Class="d-flex justify-end align-center gap-1">
                    @if (ActiveFilterCount > 0)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.FilterAltOff" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="ClearFilters"
                                       Title="Clear All Filters" />
                    }
                    <MudIconButton Icon="@Icons.Material.Filled.ExpandLess" 
                                   Size="Size.Small"
                                   OnClick="() => filtersExpanded = false"
                                   Title="Collapse Filters" />
                </MudItem>
            }
            else
            {
                <MudItem xs="12" Class="d-flex align-center justify-space-between">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.FilterList" Size="Size.Small" Color="Color.Primary" />
                        <MudText Typo="Typo.body2" Color="Color.Primary">Filters</MudText>
                        @if (ActiveFilterCount > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">@ActiveFilterCount active</MudChip>
                        }
                    </div>
                    <div class="d-flex align-center gap-1">
                        @if (ActiveFilterCount > 0)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.FilterAltOff" 
                                           Color="Color.Error" 
                                           Size="Size.Small"
                                           OnClick="ClearFilters"
                                           Title="Clear All Filters" />
                        }
                        <MudIconButton Icon="@Icons.Material.Filled.ExpandMore" 
                                       Size="Size.Small"
                                       OnClick="() => filtersExpanded = true"
                                       Title="Expand Filters" />
                    </div>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    @if (!string.IsNullOrWhiteSpace(filterDriver) || deliveriesOnly)
    {
        @* Driver-focused summary banner when filtering deliveries *@
        <MudPaper Class="mb-2 pa-2 px-3" Elevation="2">
            <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Color="Color.Primary" Size="Size.Small" />
                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">@(string.IsNullOrWhiteSpace(filterDriver) ? "All Deliveries" : filterDriver)</MudText>
                    @if (!string.IsNullOrWhiteSpace(filterDriver))
                    {
                        <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="@(() => { filterDriver = null; deliveriesOnly = true; })">Show All Drivers</MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Error" OnClick="@(() => { deliveriesOnly = false; filterStatus = null; })">Clear</MudButton>
                    }
                </div>
                <div class="d-flex gap-2 align-center">
                    <MudPaper @onclick="@(() => filterStatus = null)" Class="px-3 py-1 d-flex align-center gap-2 rounded cursor-pointer" Elevation="@(filterStatus == null ? 2 : 0)" Style="@(filterStatus == null ? "background: rgba(var(--mud-palette-primary-rgb), 0.25); outline: 2px solid var(--mud-palette-primary);" : "background: rgba(128,128,128,0.1);")">
                        <MudText Typo="Typo.subtitle1" Class="font-weight-bold">@GetDeliveryTotalCount()</MudText>
                        <MudText Typo="Typo.caption">All</MudText>
                    </MudPaper>
                    <MudPaper @onclick="@(() => filterStatus = TransactionStatus.Pending)" Class="px-3 py-1 d-flex align-center gap-2 rounded cursor-pointer" Elevation="@(filterStatus == TransactionStatus.Pending ? 2 : 0)" Style="@(filterStatus == TransactionStatus.Pending ? "background: rgba(var(--mud-palette-warning-rgb), 0.35); outline: 2px solid var(--mud-palette-warning);" : "background: rgba(var(--mud-palette-warning-rgb), 0.15);")">
                        <MudText Typo="Typo.subtitle1" Style="color: var(--mud-palette-warning);" Class="font-weight-bold">@GetDriverPendingCount()</MudText>
                        <MudText Typo="Typo.caption">Pending</MudText>
                    </MudPaper>
                    <MudPaper @onclick="@(() => filterStatus = TransactionStatus.Completed)" Class="px-3 py-1 d-flex align-center gap-2 rounded cursor-pointer" Elevation="@(filterStatus == TransactionStatus.Completed ? 2 : 0)" Style="@(filterStatus == TransactionStatus.Completed ? "background: rgba(var(--mud-palette-success-rgb), 0.35); outline: 2px solid var(--mud-palette-success);" : "background: rgba(var(--mud-palette-success-rgb), 0.15);")">
                        <MudText Typo="Typo.subtitle1" Style="color: var(--mud-palette-success);" Class="font-weight-bold">@GetDriverDeliveredCount()</MudText>
                        <MudText Typo="Typo.caption">Delivered</MudText>
                    </MudPaper>
                    <MudPaper @onclick="@(() => filterStatus = TransactionStatus.Canceled)" Class="px-3 py-1 d-flex align-center gap-2 rounded cursor-pointer" Elevation="@(filterStatus == TransactionStatus.Canceled ? 2 : 0)" Style="@(filterStatus == TransactionStatus.Canceled ? "background: rgba(var(--mud-palette-error-rgb), 0.35); outline: 2px solid var(--mud-palette-error);" : "background: rgba(var(--mud-palette-error-rgb), 0.15);")">
                        <MudText Typo="Typo.subtitle1" Style="color: var(--mud-palette-error);" Class="font-weight-bold">@GetDriverCanceledCount()</MudText>
                        <MudText Typo="Typo.caption">Canceled</MudText>
                    </MudPaper>
                    <MudPaper @onclick="@(() => filterStatus = TransactionStatus.Refunded)" Class="px-3 py-1 d-flex align-center gap-2 rounded cursor-pointer" Elevation="@(filterStatus == TransactionStatus.Refunded ? 2 : 0)" Style="@(filterStatus == TransactionStatus.Refunded ? "background: rgba(var(--mud-palette-secondary-rgb), 0.35); outline: 2px solid var(--mud-palette-secondary);" : "background: rgba(var(--mud-palette-secondary-rgb), 0.15);")">
                        <MudText Typo="Typo.subtitle1" Style="color: var(--mud-palette-secondary);" Class="font-weight-bold">@GetRefundedCount()</MudText>
                        <MudText Typo="Typo.caption">Refunded</MudText>
                    </MudPaper>
                </div>
            </div>
        </MudPaper>
    }

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0">
        @* Orders tab: main transactions grid with expandable item rows *@
        <MudTabPanel Text="Orders" Icon="@Icons.Material.Filled.Receipt">
            @if (FilteredTransactions.Count() != transactions.Count)
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                    Showing @FilteredTransactions.Count() of @transactions.Count transactions
                </MudAlert>
            }

            <MudPaper Class="pa-2" Elevation="0">
                <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
                    <MudTable Items="@FilteredTransactions" 
                              Hover="true" 
                              Dense="true" 
                              Breakpoint="Breakpoint.None"
                              Filter="new Func<Transaction, bool>(SearchFilter)"
                              @bind-SelectedItem="selectedTransaction"
                              SortLabel="Sort By"
                              RowStyleFunc="RowStyleFunc"
                              OnRowClick="OnRowClick"
                              T="Transaction"
                              Class="fixed-layout-table">
                        <ToolBarContent>
                            <MudIconButton Icon="@Icons.Material.Filled.QrCodeScanner"
                                           Color="Color.Primary"
                                           Size="Size.Medium"
                                           Title="Scan barcode to search"
                                           OnClick="OpenSearchScannerAsync"
                                           Class="mr-2" />
                            <MudTextField @bind-Value="searchString" 
                                          Placeholder="Search" 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search" 
                                          IconSize="Size.Medium" 
                                          Class="mt-0"
                                          Immediate="true">
                            </MudTextField>
                            <MudIconButton Icon="@(expandAll ? Icons.Material.Filled.UnfoldLess : Icons.Material.Filled.UnfoldMore)"
                                           Color="Color.Primary"
                                           Size="Size.Medium"
                                           OnClick="ToggleExpandAll"
                                           Title="@(expandAll ? "Collapse All" : "Expand All")"
                                           Class="ml-2" />
                            <MudSpacer />
                        </ToolBarContent>
                        <HeaderContent>
                            @if (_transactionColumns.IsVisible("Order")) { <MudTh Style="@($"width:{GetColumnWidth("Order")}")"><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<Transaction, object>(x => x.Id)">Order</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Date")) { <MudTh Style="@($"width:{GetColumnWidth("Date")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.TransactionDate)">Date</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Items")) { <MudTh Style="@($"width:{GetColumnWidth("Items")}")">Items</MudTh> }
                            @if (_transactionColumns.IsVisible("Quantity")) { <MudTh Style="@($"width:{GetColumnWidth("Quantity")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Items.Sum(i => i.Quantity))">Quantity</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Cost")) { <MudTh Style="@($"width:{GetColumnWidth("Cost")}")">Cost (LD)</MudTh> }
                            @if (_transactionColumns.IsVisible("Profit")) { <MudTh Style="@($"width:{GetColumnWidth("Profit")}")">Profit (LD)</MudTh> }
                            @if (_transactionColumns.IsVisible("Realized Profit")) { <MudTh Style="@($"width:{GetColumnWidth("Realized Profit")}")">Realized (LD)</MudTh> }
                            @if (_transactionColumns.IsVisible("Total")) { <MudTh Style="@($"width:{GetColumnWidth("Total")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.TotalAmount)">Total (LD)</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Discount")) { <MudTh Style="@($"width:{GetColumnWidth("Discount")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Discount)">Discount</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Payment")) { <MudTh Style="@($"width:{GetColumnWidth("Payment")}")">Payment</MudTh> }
                            @if (_transactionColumns.IsVisible("Delivery")) { <MudTh Style="@($"width:{GetColumnWidth("Delivery")}")">Delivery</MudTh> }
                            @if (_transactionColumns.IsVisible("Driver")) { <MudTh Style="@($"width:{GetColumnWidth("Driver")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Driver?.Name ?? string.Empty)">Driver</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Customer")) { <MudTh Style="@($"width:{GetColumnWidth("Customer")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.CustomerName ?? string.Empty)">Customer</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Note")) { <MudTh Style="@($"width:{GetColumnWidth("Note")}")">Note</MudTh> }
                            @if (_transactionColumns.IsVisible("Employee")) { <MudTh Style="@($"width:{GetColumnWidth("Employee")}")"><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.EmployeeName)">Employee</MudTableSortLabel></MudTh> }
                            @if (_transactionColumns.IsVisible("Actions")) { <MudTh Style="@($"width:{GetColumnWidth("Actions")}")">Actions</MudTh> }
                        </HeaderContent>
                        @* Main rows: transaction summary per order *@
                        <RowTemplate>
                            @if (_transactionColumns.IsVisible("Order")) {
                                <MudTd DataLabel="Order">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@(expandedTransactions.Contains(context.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                                 Size="Size.Small" 
                                                 Class="mr-2"/>
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" OnClick="@((e) => ShowPaymentHistory(context))" Style="cursor: pointer;">#@context.Id</MudChip>
                                    </div>
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Date")) { <MudTd DataLabel="Date" Style="white-space: nowrap;">@context.TransactionDate.ToDisplayString()</MudTd> }
                            @if (_transactionColumns.IsVisible("Items")) { <MudTd DataLabel="Items">@string.Join(", ", context.Items.Select(i => i.Product?.Name ?? "Unknown").Distinct())</MudTd> }
                            @if (_transactionColumns.IsVisible("Quantity")) { <MudTd DataLabel="Quantity"><b>@context.Items.Sum(i => i.Quantity)</b></MudTd> }
                            @if (_transactionColumns.IsVisible("Cost"))
                            {
                                <MudTd DataLabel="Cost">
                                    @{
                                        var cost = CalculateOrderCost(context);
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Info">
                                        <b>@cost.ToString("F2")</b>
                                    </MudChip>
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Profit"))
                            {
                                <MudTd DataLabel="Profit">
                                    @{
                                        var profit = CalculateOrderProfit(context);
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="@(profit > 0 ? Color.Success : Color.Error)">
                                        <b>@profit.ToString("F2")</b>
                                    </MudChip>
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Realized Profit"))
                            {
                                <MudTd DataLabel="Realized Profit">
                                    @{
                                        var realizedProfit = GetTransactionRealizedProfit(context);
                                    }
                                    @if (realizedProfit != 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@(realizedProfit > 0 ? Color.Success : Color.Error)">
                                            <b>@realizedProfit.ToString("F2")</b>
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                    }
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Total")) {
                                <MudTd DataLabel="Total">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Success">
                                        <b>@context.TotalAmount.ToString("F2")</b>
                                    </MudChip>
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Discount")) {
                                <MudTd DataLabel="Discount">
                                    @if (context.Discount > 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Error">
                                            -@context.Discount.ToString("F2")
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                    }
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Payment")) {
                                <MudTd DataLabel="Payment">
                                    @{
                                        var status = "Unpaid";
                                        var color = Color.Error;
                                        
                                        if (context.Status == TransactionStatus.Refunded)
                                        {
                                            status = "Refunded";
                                            color = Color.Secondary;
                                        }
                                        else if (context.Status == TransactionStatus.Canceled)
                                        {
                                            status = "Canceled";
                                            color = Color.Default;
                                        }
                                        else if (context.TotalPaid >= context.TotalAmount - 0.01m) // Tolerance for float math
                                        { 
                                            status = "Paid"; 
                                            color = Color.Success; 
                                        }
                                        else if (context.TotalPaid > 0) 
                                        { 
                                            status = "Partial"; 
                                            color = Color.Warning; 
                                        }
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@color" OnClick="@((e) => (status == "Paid" || status == "Canceled" || status == "Refunded") ? null : OpenPaymentDialog(context))" Style="@((status == "Paid" || status == "Canceled" || status == "Refunded") ? "" : "cursor: pointer;")">@status</MudChip>
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Delivery")) {
                                <MudTd DataLabel="Delivery">
                                    @if (context.IsDelivery)
                                    {
                                        var isFinalized = context.Status == TransactionStatus.Completed || context.Status == TransactionStatus.Canceled || context.Status == TransactionStatus.Refunded;
                                        <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" 
                                                       Color="@GetStatusColor(context.Status)" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => isFinalized ? Task.CompletedTask : OpenStatusDialog(context))"
                                                       Ripple="@(!isFinalized)"
                                                       Style="@(isFinalized ? "cursor: default;" : "")"
                                                       Title="@(isFinalized ? $"{context.Status} (Finalized)" : "Update Status")" />
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-center" style="width: 100%;">
                                            <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                        </div>
                                    }
                                </MudTd>
                            }
                            @if (_transactionColumns.IsVisible("Driver")) { <MudTd DataLabel="Driver">@(context.Driver?.Name ?? "-")</MudTd> }
                            @if (_transactionColumns.IsVisible("Customer")) { <MudTd DataLabel="Customer">@(context.CustomerName ?? "Walk-in")</MudTd> }
                            @if (_transactionColumns.IsVisible("Note")) { 
                                <MudTd DataLabel="Note">
                                    <div @onclick="@(() => EditNote(context))" style="cursor: pointer; display: flex; align-items: center;">
                                        @if (!string.IsNullOrEmpty(context.Note))
                                        {
                                            <MudText Typo="Typo.body2" Style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                @context.Note
                                            </MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="ml-1" Color="Color.Default" Style="opacity: 0.5;" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.AddComment" Size="Size.Small" Color="Color.Default" Style="opacity: 0.3;" />
                                        }
                                    </div>
                                </MudTd> 
                            }
                            @if (_transactionColumns.IsVisible("Employee")) { <MudTd DataLabel="Employee">@context.EmployeeName</MudTd> }
                            @if (_transactionColumns.IsVisible("Actions")) {
                                <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                                    <div class="d-flex align-center">
                                        <MudMenu Icon="@Icons.Material.Filled.Print" Color="Color.Info" Size="Size.Small" Dense="true">
                                            <MudMenuItem OnClick="@(() => PrintReceipt(context))">Print Receipt (Thermal)</MudMenuItem>
                                            <MudMenuItem OnClick="@(() => PrintInvoice(context))">Print Invoice (A4)</MudMenuItem>
                                        </MudMenu>
                                        @if (context.Status != TransactionStatus.Refunded && context.Status != TransactionStatus.Canceled)
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.Undo" 
                                                           Color="Color.Warning" 
                                                           Size="Size.Small"
                                                           Title="Refund Order"
                                                           OnClick="@(() => OpenRefundDialog(context))" />
                                        }
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Color="Color.Error" 
                                                       Size="Size.Small" 
                                                       OnClick="@(() => DeleteTransaction(context))" />
                                    </div>
                                </MudTd>
                            }
                        </RowTemplate>
                        @* Expanded rows: line items under a transaction *@
                        <ChildRowContent Context="trans">
                            @if (expandedTransactions.Contains(trans.Id))
                            {
                                @foreach (var item in trans.Items)
                                {
                                    <MudTr Style="background-color: var(--mud-palette-background-grey);">
                                        @if (_transactionColumns.IsVisible("Order")) { 
                                            <MudTd Style="border-left: 4px solid var(--mud-palette-primary);"></MudTd> 
                                        }
                                        @if (_transactionColumns.IsVisible("Date")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Items")) {
                                            <MudTd>
                                                <div class="d-flex align-center">
                                                    <MudText Typo="Typo.caption" Class="mr-2" Color="Color.Default">(@item.UnitPrice.ToString("F2"))</MudText>
                                                    @if (item.Product != null)
                                                    {
                                                        <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                                       Color="Color.Default"
                                                                       Size="Size.Small"
                                                                       Class="mr-2"
                                                                       OnClick="@(() => ShowProductDetails(item.Product!))" />
                                                    }
                                                    <MudText>@item.Product?.Name</MudText>
                                                </div>
                                            </MudTd>
                                        }
                                        @if (_transactionColumns.IsVisible("Quantity")) { <MudTd><b>@item.Quantity</b></MudTd> }
                                        @if (_transactionColumns.IsVisible("Cost"))
                                        {
                                            <MudTd>
                                                <MudText Typo="Typo.body2" Color="Color.Info">
                                                    <b>@(((item.UnitCost > 0 ? item.UnitCost : item.Product?.CostPrice ?? 0) * item.Quantity).ToString("F2"))</b>
                                                </MudText>
                                            </MudTd>
                                        }
                                        @if (_transactionColumns.IsVisible("Profit"))
                                        {
                                            <MudTd>
                                                @{
                                                    var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
                                                    var itemProfit = (item.UnitPrice - cost) * item.Quantity;
                                                }
                                                <MudText Typo="Typo.body2" Color="@(itemProfit > 0 ? Color.Success : Color.Error)">
                                                    <b>@itemProfit.ToString("F2")</b>
                                                </MudText>
                                            </MudTd>
                                        }
                                        @if (_transactionColumns.IsVisible("Total")) { <MudTd><b>@item.Subtotal.ToString("F2")</b></MudTd> }
                                        @if (_transactionColumns.IsVisible("Discount")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Payment")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Delivery")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Driver")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Customer")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Note")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Employee")) { <MudTd></MudTd> }
                                        @if (_transactionColumns.IsVisible("Actions")) { <MudTd></MudTd> }
                                    </MudTr>
                                }
                                @if (trans.Discount > 0)
                                {
                                    <MudTr Style="background-color: var(--mud-palette-background-grey);">
                                        <td colspan="20">
                                            <div class="d-flex justify-end gap-4 px-4 py-1" style="border-left: 4px solid var(--mud-palette-primary);">
                                                <MudText Typo="Typo.body2"><b>Subtotal:</b> @((trans.TotalAmount + trans.Discount).ToString("F2"))</MudText>
                                                <MudText Typo="Typo.body2" Color="Color.Error"><b>Discount:</b> -@trans.Discount.ToString("F2")</MudText>
                                                <MudText Typo="Typo.body2" Color="Color.Primary"><b>Total:</b> @trans.TotalAmount.ToString("F2")</MudText>
                                            </div>
                                        </td>
                                    </MudTr>
                                }
                            }
                        </ChildRowContent>
                        @* Footer aggregates for currently filtered set *@
                        <FooterContent>
                            @if (_transactionColumns.IsVisible("Order")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@FilteredTransactions.Count() orders</MudTh> }
                            @if (_transactionColumns.IsVisible("Date")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Items")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Quantity")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetFilteredQuantity()</MudTh> }
                            @if (_transactionColumns.IsVisible("Cost")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetFilteredCost().ToString("N2")</MudTh> }
                            @if (_transactionColumns.IsVisible("Profit")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetFilteredProfit().ToString("N2")</MudTh> }
                            @if (_transactionColumns.IsVisible("Realized Profit")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetFilteredRealizedProfit().ToString("N2")</MudTh> }
                            @if (_transactionColumns.IsVisible("Total")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetFilteredTotal().ToString("N2")</MudTh> }
                            @if (_transactionColumns.IsVisible("Discount")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetFilteredDiscount().ToString("N2")</MudTh> }
                            @if (_transactionColumns.IsVisible("Payment")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Delivery")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Driver")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Customer")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Note")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Employee")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                            @if (_transactionColumns.IsVisible("Actions")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                        </FooterContent>
                        <PagerContent>
                            <div class="d-flex align-center justify-space-between px-4 py-2">
                                <TableColumnToggle Columns="@_transactionColumns" ColumnsChanged="StateHasChanged" TableName="Transactions" MaxHeight="400" />
                                <MudTablePager />
                            </div>
                        </PagerContent>
                    </MudTable>
                </div>
            </MudPaper>
        </MudTabPanel>

        @* Payments tab: payment history list *@
        <MudTabPanel Text="Payments" Icon="@Icons.Material.Filled.History">
            @if (payments == null)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                <MudTable Items="@FilteredPayments" Hover="true" Dense="true" Breakpoint="Breakpoint.None">
                    <ToolBarContent>
                        <MudSpacer />
                        <MudTextField @bind-Value="paymentSearchString" 
                                      Placeholder="Search Payments" 
                                      Adornment="Adornment.Start" 
                                      AdornmentIcon="@Icons.Material.Filled.Search" 
                                      IconSize="Size.Medium" 
                                      Class="mt-0"
                                      Immediate="true">
                        </MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (_paymentColumns.IsVisible("Payment ID")) { <MudTh>Payment ID</MudTh> }
                        @if (_paymentColumns.IsVisible("Realized Profit")) { <MudTh>Realized Profit</MudTh> }
                        @if (_paymentColumns.IsVisible("Date")) { <MudTh>Date</MudTh> }
                        @if (_paymentColumns.IsVisible("Method")) { <MudTh Class="d-none d-sm-table-cell">Method</MudTh> }
                        @if (_paymentColumns.IsVisible("Reference")) { <MudTh Class="d-none d-sm-table-cell">Reference</MudTh> }
                        @if (_paymentColumns.IsVisible("Amount")) { <MudTh>Amount</MudTh> }
                        @if (_paymentColumns.IsVisible("Allocations")) { <MudTh>Allocations</MudTh> }
                        @if (_paymentColumns.IsVisible("Actions")) { <MudTh>Actions</MudTh> }
                    </HeaderContent>
                    <RowTemplate>
                        @if (_paymentColumns.IsVisible("Payment ID")) { <MudTd DataLabel="Payment ID">#@context.Id</MudTd> }
                        @if (_paymentColumns.IsVisible("Realized Profit")) {
                            <MudTd DataLabel="Realized Profit">
                                @{
                                    var realizedProfit = GetRealizedProfit(context);
                                }
                                @if (realizedProfit != 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@(realizedProfit > 0 ? Color.Success : Color.Error)">
                                        LD @realizedProfit.ToString("F2")
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                }
                            </MudTd>
                        }
                        @if (_paymentColumns.IsVisible("Date")) { <MudTd DataLabel="Date" Style="white-space: nowrap;">@context.PaymentDate.ToDisplayString()</MudTd> }
                        @if (_paymentColumns.IsVisible("Method")) { <MudTd DataLabel="Method" Class="d-none d-sm-table-cell">@context.PaymentMethod</MudTd> }
                        @if (_paymentColumns.IsVisible("Reference")) { <MudTd DataLabel="Reference" Class="d-none d-sm-table-cell">@context.Reference</MudTd> }
                        @if (_paymentColumns.IsVisible("Amount")) {
                            <MudTd DataLabel="Amount">
                                <MudText Color="Color.Success" Class="font-weight-bold">
                                    LD @context.Amount.ToString("F2")
                                </MudText>
                            </MudTd>
                        }
                        @if (_paymentColumns.IsVisible("Allocations")) {
                            <MudTd DataLabel="Allocations">
                                <MudText Typo="Typo.body2">
                                    @string.Join(", ", context.Allocations.Select(a => $"#{a.TransactionId}: {a.Amount:F2}"))
                                </MudText>
                            </MudTd>
                        }
                        @if (_paymentColumns.IsVisible("Actions")) {
                            <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                               Color="Color.Error" 
                                               Size="Size.Small" 
                                               OnClick="@(() => DeletePayment(context))" />
                            </MudTd>
                        }
                    </RowTemplate>
                    <FooterContent>
                        @if (_paymentColumns.IsVisible("Payment ID")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@FilteredPayments.Count() payments</MudTh> }
                        @if (_paymentColumns.IsVisible("Realized Profit")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetPaymentsTotalRealizedProfit().ToString("N2")</MudTh> }
                        @if (_paymentColumns.IsVisible("Date")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                        @if (_paymentColumns.IsVisible("Method")) { <MudTh Style="background: var(--mud-palette-background-gray);" Class="d-none d-sm-table-cell"></MudTh> }
                        @if (_paymentColumns.IsVisible("Reference")) { <MudTh Style="background: var(--mud-palette-background-gray);" Class="d-none d-sm-table-cell"></MudTh> }
                        @if (_paymentColumns.IsVisible("Amount")) { <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetPaymentsTotalAmount().ToString("N2")</MudTh> }
                        @if (_paymentColumns.IsVisible("Allocations")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                        @if (_paymentColumns.IsVisible("Actions")) { <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh> }
                    </FooterContent>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_paymentColumns" ColumnsChanged="StateHasChanged" TableName="TransactionPayments" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            }
        </MudTabPanel>

        @* Outstanding invoices tab: unpaid transactions *@
        <MudTabPanel Text="Outstanding Invoices" Icon="@Icons.Material.Filled.PendingActions">
            @{
                var unpaidTransactions = FilteredTransactions.Where(t => t.BalanceDue > 0.01m).ToList();
            }
            @if (!unpaidTransactions.Any())
            {
                <MudAlert Severity="Severity.Success">No outstanding invoices matching filters!</MudAlert>
            }
            else
            {
                <MudTable Items="@unpaidTransactions" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Transaction, bool>(SearchFilter)">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Unpaid Invoices</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (_invoiceColumns.IsVisible("Order")) { <MudTh>Order</MudTh> }
                        @if (_invoiceColumns.IsVisible("Date")) { <MudTh>Date</MudTh> }
                        @if (_invoiceColumns.IsVisible("Customer")) { <MudTh>Customer</MudTh> }
                        @if (_invoiceColumns.IsVisible("Total")) { <MudTh>Total</MudTh> }
                        @if (_invoiceColumns.IsVisible("Paid")) { <MudTh>Paid</MudTh> }
                        @if (_invoiceColumns.IsVisible("Balance")) { <MudTh>Balance</MudTh> }
                        @if (_invoiceColumns.IsVisible("Action")) { <MudTh>Action</MudTh> }
                    </HeaderContent>
                    <RowTemplate>
                        @if (_invoiceColumns.IsVisible("Order")) { <MudTd DataLabel="Order">#@context.Id</MudTd> }
                        @if (_invoiceColumns.IsVisible("Date")) { <MudTd DataLabel="Date" Style="white-space: nowrap;">@context.TransactionDate.ToDateOnlyString()</MudTd> }
                        @if (_invoiceColumns.IsVisible("Customer")) { <MudTd DataLabel="Customer">@(context.CustomerName ?? "Walk-in")</MudTd> }
                        @if (_invoiceColumns.IsVisible("Total")) { <MudTd DataLabel="Total">LD @context.TotalAmount.ToString("F2")</MudTd> }
                        @if (_invoiceColumns.IsVisible("Paid")) { <MudTd DataLabel="Paid">LD @context.TotalPaid.ToString("F2")</MudTd> }
                        @if (_invoiceColumns.IsVisible("Balance")) {
                            <MudTd DataLabel="Balance">
                                <MudText Color="Color.Error" Class="font-weight-bold">
                                    LD @context.BalanceDue.ToString("F2")
                                </MudText>
                            </MudTd>
                        }
                        @if (_invoiceColumns.IsVisible("Action")) {
                            <MudTd DataLabel="Action" Style="white-space: nowrap;">
                                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="@(() => OpenPaymentDialog(context))">
                                    Pay
                                </MudButton>
                            </MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_invoiceColumns" ColumnsChanged="StateHasChanged" TableName="TransactionInvoices" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    // UI state and cached data
    private List<Transaction>? transactions;
    private Dictionary<int, Transaction> _transactionsById = new();
    private List<Payment>? payments;
    private Dictionary<int, List<Payment>> _paymentsByTransactionId = new();
    private Transaction? selectedTransaction;
    private string searchString = "";
    private string paymentSearchString = "";
    private HashSet<int> expandedTransactions = new();
    private bool expandAll = false;

    // Column visibility configuration per tab
    private List<ColumnDefinition> _transactionColumns = new()
    {
        new() { Title = "Order", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Items", IsVisible = true },
        new() { Title = "Quantity", IsVisible = true },
        new() { Title = "Cost", IsVisible = false },
        new() { Title = "Profit", IsVisible = false },
        new() { Title = "Realized Profit", IsVisible = false },
        new() { Title = "Total", IsVisible = true },
        new() { Title = "Discount", IsVisible = true },
        new() { Title = "Payment", IsVisible = true },
        new() { Title = "Delivery", IsVisible = true },
        new() { Title = "Driver", IsVisible = true },
        new() { Title = "Customer", IsVisible = true },
        new() { Title = "Note", IsVisible = true },
        new() { Title = "Employee", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _paymentColumns = new()
    {
        new() { Title = "Payment ID", IsVisible = true },
        new() { Title = "Realized Profit", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Method", IsVisible = true },
        new() { Title = "Reference", IsVisible = true },
        new() { Title = "Amount", IsVisible = true },
        new() { Title = "Allocations", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _invoiceColumns = new()
    {
        new() { Title = "Order", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Customer", IsVisible = true },
        new() { Title = "Total", IsVisible = true },
        new() { Title = "Paid", IsVisible = true },
        new() { Title = "Balance", IsVisible = true },
        new() { Title = "Action", IsVisible = true }
    };


    // Filter variables
    private bool filtersExpanded = true;
    private DateTime? filterFromDate;
    private DateTime? filterToDate;
    private Product? selectedProductFilter;
    private string? filterCustomer;
    private string? filterEmployee;
    private string? filterDriver;
    private TransactionStatus? filterStatus;
    private bool deliveriesOnly;

    // Count of active filters for badge display
    private int ActiveFilterCount =>
        (filterFromDate.HasValue ? 1 : 0) +
        (filterToDate.HasValue ? 1 : 0) +
        (selectedProductFilter != null ? 1 : 0) +
        (!string.IsNullOrWhiteSpace(filterCustomer) ? 1 : 0) +
        (!string.IsNullOrWhiteSpace(filterEmployee) ? 1 : 0) +
        (!string.IsNullOrWhiteSpace(filterDriver) ? 1 : 0);

    // Apply all active filters to transactions
    private IEnumerable<Transaction> FilteredTransactions
    {
        get
        {
            if (transactions == null) return Enumerable.Empty<Transaction>();

            var filtered = transactions.AsEnumerable();

            // Date range filter
            if (filterFromDate.HasValue)
            {
                filtered = filtered.Where(t => t.TransactionDate.Date >= filterFromDate.Value.Date);
            }
            if (filterToDate.HasValue)
            {
                filtered = filtered.Where(t => t.TransactionDate.Date <= filterToDate.Value.Date);
            }

            // Product filter
            if (selectedProductFilter != null)
            {
                filtered = filtered.Where(t => t.Items.Any(i => i.ProductId == selectedProductFilter.Id));
            }

            // Customer filter
            if (!string.IsNullOrWhiteSpace(filterCustomer))
            {
                if (filterCustomer == "Walk-in")
                {
                    filtered = filtered.Where(t => string.IsNullOrWhiteSpace(t.CustomerName));
                }
                else
                {
                    filtered = filtered.Where(t => t.CustomerName == filterCustomer);
                }
            }

            // Employee filter
            if (!string.IsNullOrWhiteSpace(filterEmployee))
            {
                filtered = filtered.Where(t => t.EmployeeName == filterEmployee);
            }

            // Driver filter
            if (!string.IsNullOrWhiteSpace(filterDriver))
            {
                filtered = filtered.Where(t => (t.Driver?.Name ?? "") == filterDriver);
            }

            // Deliveries only filter (show all deliveries regardless of driver)
            if (deliveriesOnly)
            {
                filtered = filtered.Where(t => t.IsDelivery);
            }

            // Status filter
            if (filterStatus.HasValue)
            {
                filtered = filtered.Where(t => t.Status == filterStatus.Value);
            }

            return filtered;
        }
    }

    // Apply filters to payments list
    private IEnumerable<Payment> FilteredPayments
    {
        get
        {
            if (payments == null) return Enumerable.Empty<Payment>();

            var filtered = payments.AsEnumerable();

            // Date range filter
            if (filterFromDate.HasValue)
            {
                filtered = filtered.Where(p => p.PaymentDate.Date >= filterFromDate.Value.Date);
            }
            if (filterToDate.HasValue)
            {
                filtered = filtered.Where(p => p.PaymentDate.Date <= filterToDate.Value.Date);
            }

            // Customer filter
            if (!string.IsNullOrWhiteSpace(filterCustomer))
            {
                if (filterCustomer == "Walk-in")
                {
                    filtered = filtered.Where(p => string.IsNullOrWhiteSpace(p.CustomerName));
                }
                else
                {
                    filtered = filtered.Where(p => p.CustomerName == filterCustomer);
                }
            }

            // Search filter
            if (!string.IsNullOrWhiteSpace(paymentSearchString))
            {
                filtered = filtered.Where(p => 
                    p.Id.ToString().Contains(paymentSearchString) ||
                    (p.CustomerName ?? "Walk-in").Contains(paymentSearchString, StringComparison.OrdinalIgnoreCase) ||
                    (p.Reference ?? "").Contains(paymentSearchString, StringComparison.OrdinalIgnoreCase) ||
                    p.Amount.ToString().Contains(paymentSearchString) ||
                    p.Allocations.Any(a => a.TransactionId.ToString().Contains(paymentSearchString))
                );
            }

            return filtered.OrderByDescending(p => p.PaymentDate);
        }
    }

    // Text search across transaction fields
    private bool SearchFilter(Transaction transaction)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (transaction.Id.ToString().Contains(searchString))
            return true;
        if (transaction.EmployeeName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if ((transaction.CustomerName ?? "Walk-in").Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if ((transaction.Note ?? "").Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (transaction.TotalAmount.ToString().Contains(searchString))
            return true;
        if (transaction.Items.Any(i => i.Product?.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false))
            return true;
        return false;
    }

    // Initial load: honor driver query parameter then fetch data
    protected override async Task OnInitializedAsync()
    {
        // Check for driver query parameter
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = uri.Query;
        if (!string.IsNullOrEmpty(query) && query.Contains("driver="))
        {
            var driverIndex = query.IndexOf("driver=") + 7;
            var driverValue = query.Substring(driverIndex);
            var ampersandIndex = driverValue.IndexOf('&');
            if (ampersandIndex > 0)
            {
                driverValue = driverValue.Substring(0, ampersandIndex);
            }
            filterDriver = Uri.UnescapeDataString(driverValue);
        }

        await TransactionService.RefreshDataAsync();
        await LoadData();
    }

    // Fetch transactions/payments and build quick lookups
    private async Task LoadData()
    {
        try
        {
            transactions = await TransactionService.GetTransactionsAsync();
            payments = await TransactionService.GetPaymentsAsync();
            
            // Index transactions for fast lookup
            if (transactions != null)
            {
                _transactionsById = transactions.ToDictionary(t => t.Id);
            }

            // Pre-calculate payment lookup for performance
            _paymentsByTransactionId.Clear();
            if (payments != null)
            {
                foreach (var p in payments)
                {
                    if (p.Allocations == null) continue;
                    foreach (var a in p.Allocations)
                    {
                        if (!_paymentsByTransactionId.ContainsKey(a.TransactionId))
                        {
                            _paymentsByTransactionId[a.TransactionId] = new List<Payment>();
                        }
                        _paymentsByTransactionId[a.TransactionId].Add(p);
                    }
                }
                
                // Sort by date for correct cumulative calculation
                foreach (var list in _paymentsByTransactionId.Values)
                {
                    list.Sort((a, b) => a.PaymentDate.CompareTo(b.PaymentDate));
                }
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error loading data: {ex.Message}");
        }
    }

    // Highlight expanded rows
    private string RowStyleFunc(Transaction transaction, int index)
    {
        if (expandedTransactions.Contains(transaction.Id))
        {
            return "background-color: rgba(var(--mud-palette-primary-rgb), 0.08);";
        }
        return string.Empty;
    }

    // Toggle expansion on row click
    private void OnRowClick(TableRowClickEventArgs<Transaction> args)
    {
        if (args.Item != null)
        {
            ToggleExpanded(args.Item.Id);
        }
    }

    // Expand/collapse single transaction
    private void ToggleExpanded(int transactionId)
    {
        if (expandedTransactions.Contains(transactionId))
        {
            expandedTransactions.Remove(transactionId);
        }
        else
        {
            expandedTransactions.Add(transactionId);
        }
    }

    // Expand/collapse all visible transactions
    private void ToggleExpandAll()
    {
        expandAll = !expandAll;
        
        if (expandAll)
        {
            // Expand all visible transactions
            if (transactions != null)
            {
                expandedTransactions = FilteredTransactions.Select(t => t.Id).ToHashSet();
            }
        }
        else
        {
            // Collapse all transactions
            expandedTransactions.Clear();
        }
    }

    // Reset all filters to defaults
    private void ClearFilters()
    {
        filterFromDate = null;
        filterToDate = null;
        selectedProductFilter = null;
        filterCustomer = null;
        filterEmployee = null;
        filterDriver = null;
        filterStatus = null;
        deliveriesOnly = false;
    }

    // Driver stats helpers - use base filtered set (without status filter) for counts
    private IEnumerable<Transaction> GetDeliveryBaseSet()
    {
        if (transactions == null) return Enumerable.Empty<Transaction>();
        var filtered = transactions.AsEnumerable();
        if (filterFromDate.HasValue) filtered = filtered.Where(t => t.TransactionDate.Date >= filterFromDate.Value.Date);
        if (filterToDate.HasValue) filtered = filtered.Where(t => t.TransactionDate.Date <= filterToDate.Value.Date);
        if (!string.IsNullOrWhiteSpace(filterDriver)) filtered = filtered.Where(t => (t.Driver?.Name ?? "") == filterDriver);
        if (deliveriesOnly || !string.IsNullOrWhiteSpace(filterDriver)) filtered = filtered.Where(t => t.IsDelivery);
        return filtered;
    }
    private int GetDeliveryTotalCount() => GetDeliveryBaseSet().Count();
    private int GetDriverPendingCount() => GetDeliveryBaseSet().Count(t => t.Status == TransactionStatus.Pending);
    private int GetDriverDeliveredCount() => GetDeliveryBaseSet().Count(t => t.Status == TransactionStatus.Completed);
    private int GetDriverCanceledCount() => GetDeliveryBaseSet().Count(t => t.Status == TransactionStatus.Canceled);
    private int GetRefundedCount() => GetDeliveryBaseSet().Count(t => t.Status == TransactionStatus.Refunded);
    private decimal GetDriverTotalAmount() => GetDeliveryBaseSet().Where(t => t.Status != TransactionStatus.Canceled && t.Status != TransactionStatus.Refunded).Sum(t => t.TotalAmount);
    
    // Footer totals for filtered transactions (excludes canceled and refunded)
    private decimal GetFilteredTotal() => FilteredTransactions.Where(t => t.Status != TransactionStatus.Canceled && t.Status != TransactionStatus.Refunded).Sum(t => t.TotalAmount);
    private int GetFilteredQuantity() => FilteredTransactions.Where(t => t.Status != TransactionStatus.Canceled && t.Status != TransactionStatus.Refunded).Sum(t => t.Items.Sum(i => i.Quantity));
    private decimal GetFilteredCost() => FilteredTransactions.Where(t => t.Status != TransactionStatus.Canceled && t.Status != TransactionStatus.Refunded).Sum(t => t.Items.Sum(i => i.UnitCost * i.Quantity));
    private decimal GetFilteredProfit() => FilteredTransactions.Where(t => t.Status != TransactionStatus.Canceled && t.Status != TransactionStatus.Refunded).Sum(t => t.Items.Sum(i => (i.UnitPrice - i.UnitCost) * i.Quantity) - t.Discount);
    private decimal GetFilteredDiscount() => FilteredTransactions.Where(t => t.Status != TransactionStatus.Canceled && t.Status != TransactionStatus.Refunded).Sum(t => t.Discount);
    private decimal GetFilteredRealizedProfit() => FilteredTransactions.Sum(t => GetTransactionRealizedProfit(t));

    // Footer totals for payments
    private decimal GetPaymentsTotalAmount() => FilteredPayments.Sum(p => p.Amount);
    private decimal GetPaymentsTotalRealizedProfit() => FilteredPayments.Sum(p => GetRealizedProfit(p));

    private IDialogReference? _searchScannerDialog;

    // Open barcode scanner dialog for quick search
    private async Task OpenSearchScannerAsync()
    {
        var parameters = new DialogParameters<M_Wallet.Client.Components.BarcodeScannerDialog>
        {
            { x => x.OnDetected, EventCallback.Factory.Create<string>(this, HandleSearchBarcodeDetectedAsync) },
            { x => x.OnCancel, EventCallback.Factory.Create(this, CloseSearchScannerAsync) }
        };

        var options = new DialogOptions
        {
            FullScreen = true,
            CloseButton = true
        };

        _searchScannerDialog = await DialogService.ShowAsync<M_Wallet.Client.Components.BarcodeScannerDialog>("Scan Product", parameters, options);
    }

    private async Task HandleSearchBarcodeDetectedAsync(string code)
    {
        if (!string.IsNullOrWhiteSpace(code))
        {
            searchString = code;
            Notify.Info($"Searching for barcode {code}");
        }
        await CloseSearchScannerAsync();
    }

    private Task CloseSearchScannerAsync()
    {
        _searchScannerDialog?.Close();
        _searchScannerDialog = null;
        return Task.CompletedTask;
    }

    // Sum cost for an order using unit cost fallbacks
    private decimal CalculateOrderCost(Transaction transaction)
    {
        return transaction.Items.Sum(item => 
            (item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0)) * item.Quantity);
    }

    // Gross profit minus discount for an order
    private decimal CalculateOrderProfit(Transaction transaction)
    {
        if (transaction.Items == null) return 0;
        var grossProfit = transaction.Items.Sum(item =>
        {
            var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
            return (item.UnitPrice - cost) * item.Quantity;
        });
        return grossProfit - transaction.Discount;
    }

    // Autocomplete: unique products search
    private Task<IEnumerable<Product>> SearchProducts(string value, CancellationToken token)
    {
        var products = GetUniqueProducts();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? products 
            : products.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    // Autocomplete: customers search
    private Task<IEnumerable<string>> SearchCustomers(string value, CancellationToken token)
    {
        var customers = GetUniqueCustomers();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? customers 
            : customers.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private List<Product> GetUniqueProducts()
    {
        if (transactions == null) return new();

        return transactions
            .SelectMany(t => t.Items)
            .Where(i => i.Product != null)
            .Select(i => i.Product!)
            .GroupBy(p => p.Id)
            .Select(g => g.First())
            .OrderBy(p => p.Name)
            .ToList();
    }

    private List<string> GetUniqueCustomers()
    {
        if (transactions == null) return new();

        return transactions
            .Select(t => string.IsNullOrWhiteSpace(t.CustomerName) ? "Walk-in" : t.CustomerName)
            .Distinct()
            .OrderBy(c => c)
            .ToList();
    }

    private List<string> GetUniqueEmployees()
    {
        if (transactions == null) return new();

        return transactions
            .Select(t => t.EmployeeName)
            .Distinct()
            .OrderBy(e => e)
            .ToList();
    }

    // Autocomplete: employees search
    private Task<IEnumerable<string>> SearchEmployees(string value, CancellationToken token)
    {
        var employees = GetUniqueEmployees();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? employees 
            : employees.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private List<string> GetUniqueDrivers()
    {
        if (transactions == null) return new();

        return transactions
            .Where(t => t.Driver != null)
            .Select(t => t.Driver!.Name)
            .Distinct()
            .OrderBy(d => d)
            .ToList();
    }

    // Autocomplete: drivers search
    private Task<IEnumerable<string>> SearchDrivers(string value, CancellationToken token)
    {
        var drivers = GetUniqueDrivers();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? drivers 
            : drivers.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    // Open payment dialog for a transaction
    private async Task OpenPaymentDialog(Transaction transaction)
    {
        var parameters = new DialogParameters 
        { 
            ["TransactionId"] = transaction.Id,
            ["BalanceDue"] = transaction.BalanceDue,
            ["CustomerName"] = transaction.CustomerName
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PaymentDialog>("Process Payment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await TransactionService.RefreshDataAsync();
            await LoadData();
        }
    }

    // View payment history dialog
    private async Task ShowPaymentHistory(Transaction transaction)
    {
        var parameters = new DialogParameters { ["Transaction"] = transaction };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PaymentHistoryDialog>($"Payment History - Order #{transaction.Id}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await TransactionService.RefreshDataAsync();
            await LoadData();
        }
    }

    // Show product details dialog
    private async Task ShowProductDetails(Product product)
    {
        var parameters = new DialogParameters { ["Product"] = product };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<ProductDetailsDialog>(product.Name, parameters, options);
    }

    // Trigger receipt print (thermal)
    private async Task PrintReceipt(Transaction transaction)
    {
        var html = _receiptService.GenerateReceiptHtml(transaction);
        await JSRuntime.InvokeVoidAsync("printer.printHtml", html);
    }

    // Trigger invoice print (A4)
    private async Task PrintInvoice(Transaction transaction)
    {
        var html = _receiptService.GenerateInvoiceHtml(transaction);
        await JSRuntime.InvokeVoidAsync("printer.printHtml", html);
    }

    // Edit inline note for a transaction
    private async Task EditNote(Transaction transaction)
    {
        var parameters = new DialogParameters<M_Wallet.Client.Components.NoteDialog>
        {
            { x => x.Note, transaction.Note ?? "" }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<M_Wallet.Client.Components.NoteDialog>("Edit Note", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newNote = result.Data as string;
            if (transaction.Note != newNote)
            {
                transaction.Note = newNote;
                try
                {
                    var response = await Http.PutAsJsonAsync($"api/transactions/{transaction.Id}", transaction);
                    if (response.IsSuccessStatusCode)
                    {
                        Notify.Success("Note updated");
                    }
                    else
                    {
                        Notify.Error("Failed to update note");
                        await LoadData();
                    }
                }
                catch (Exception ex)
                {
                    Notify.Error($"Error: {ex.Message}");
                }
            }
        }
    }

    // Delete a transaction after confirmation
    private async Task DeleteTransaction(Transaction transaction)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Transaction", 
            $"Are you sure you want to delete Order #{transaction.Id}? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var currentUser = await AuthStateProvider.GetCurrentUserAsync();
                var employeeName = currentUser?.Name ?? "Unknown";
                var response = await Http.DeleteAsync($"api/transactions/{transaction.Id}?employeeName={Uri.EscapeDataString(employeeName)}");
                
                if (response.IsSuccessStatusCode)
                {
                    Notify.Success("Transaction deleted");
                    await TransactionService.RefreshDataAsync();
                    await LoadData();
                }
                else
                {
                    Notify.Error("Failed to delete transaction");
                }
            }
            catch (Exception ex)
            {
                Notify.Error($"Error: {ex.Message}");
            }
        }
    }

    // Open refund dialog and process refund
    private async Task OpenRefundDialog(Transaction transaction)
    {
        var parameters = new DialogParameters<M_Wallet.Client.Components.RefundDialog>
        {
            { x => x.Transaction, transaction }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<M_Wallet.Client.Components.RefundDialog>($"Refund Order #{transaction.Id}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is M_Wallet.Client.Components.RefundDialogResult refundResult)
        {
            try
            {
                var currentUser = await AuthStateProvider.GetCurrentUserAsync();
                var request = new
                {
                    PaymentMethod = refundResult.PaymentMethod,
                    Reason = refundResult.Reason,
                    EmployeeName = currentUser?.Name ?? "Unknown"
                };

                var response = await Http.PostAsJsonAsync($"api/transactions/{transaction.Id}/refund", request);
                
                if (response.IsSuccessStatusCode)
                {
                    Notify.Success($"Order #{transaction.Id} refunded successfully");
                    await TransactionService.RefreshDataAsync();
                    await LoadData();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Notify.Error($"Failed to refund: {error}");
                }
            }
            catch (Exception ex)
            {
                Notify.Error($"Error: {ex.Message}");
            }
        }
    }

    // Delete a payment after confirmation
    private async Task DeletePayment(Payment payment)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Payment", 
            $"Are you sure you want to delete Payment #{payment.Id} (LD {payment.Amount:F2})? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/payments/{payment.Id}");
                if (response.IsSuccessStatusCode)
                {
                    Notify.Success("Payment deleted");
                    await TransactionService.RefreshDataAsync();
                    await LoadData();
                }
                else
                {
                    Notify.Error("Failed to delete payment");
                }
            }
            catch (Exception ex)
            {
                Notify.Error($"Error: {ex.Message}");
            }
        }
    }

    // Compute realized profit when this payment fully completes a transaction
    // For refunds (negative payments), return negative realized profit to offset
    private decimal GetRealizedProfit(Payment payment)
    {
        decimal totalRealizedProfit = 0;
        if (payment.Allocations == null || !payment.Allocations.Any()) return 0;

        foreach (var allocation in payment.Allocations)
        {
            // Look up transaction from our local index instead of relying on nested object
            if (!_transactionsById.TryGetValue(allocation.TransactionId, out var transaction))
            {
                continue;
            }
            
            if (transaction.Items == null || !transaction.Items.Any()) continue;

            // Handle refund payments (negative amounts) - return negative profit to offset
            if (payment.Amount < 0)
            {
                // This is a refund - return negative realized profit
                totalRealizedProfit += CalculateOrderProfit(transaction) * -1;
                continue;
            }

            // Find all payments for this transaction using the pre-calculated lookup
            if (!_paymentsByTransactionId.TryGetValue(transaction.Id, out var allPaymentsForTransaction))
            {
                continue;
            }

            // Calculate cumulative paid amount up to and including this payment
            decimal cumulative = 0;
            bool isCompletingPayment = false;

            foreach (var p in allPaymentsForTransaction)
            {
                // Skip negative payments (refunds) when calculating cumulative for completion
                if (p.Amount < 0) continue;
                
                var allocationAmount = p.Allocations.FirstOrDefault(a => a.TransactionId == transaction.Id)?.Amount ?? 0;
                cumulative += allocationAmount;

                if (p.Id == payment.Id)
                {
                    // This payment completes the transaction if cumulative reaches total
                    if (cumulative >= transaction.TotalAmount - 0.01m)
                    {
                        isCompletingPayment = true;
                    }
                    break;
                }
            }

            if (isCompletingPayment)
            {
                totalRealizedProfit += CalculateOrderProfit(transaction);
            }
        }
        return totalRealizedProfit;
    }

    // Calculate the total realized profit for a transaction
    // This is the sum of all realized profits from payments linked to this transaction
    // For a fully paid order: returns order profit
    // For a refunded order: returns 0 (original profit + negative refund profit)
    // For unpaid/partially paid: returns 0 (not yet realized)
    private decimal GetTransactionRealizedProfit(Transaction transaction)
    {
        if (!_paymentsByTransactionId.TryGetValue(transaction.Id, out var paymentsForTransaction))
        {
            return 0;
        }

        decimal totalRealized = 0;
        foreach (var payment in paymentsForTransaction)
        {
            // Get the realized profit contribution from this payment for this transaction
            var alloc = payment.Allocations?.FirstOrDefault(a => a.TransactionId == transaction.Id);
            if (alloc == null) continue;

            // For refund payments (negative), add negative profit
            if (payment.Amount < 0)
            {
                totalRealized += CalculateOrderProfit(transaction) * -1;
                continue;
            }

            // For positive payments, check if this payment completed the transaction
            decimal cumulative = 0;
            foreach (var p in paymentsForTransaction)
            {
                if (p.Amount < 0) continue; // Skip refunds for cumulative calc
                var amt = p.Allocations?.FirstOrDefault(a => a.TransactionId == transaction.Id)?.Amount ?? 0;
                cumulative += amt;

                if (p.Id == payment.Id)
                {
                    if (cumulative >= transaction.TotalAmount - 0.01m)
                    {
                        totalRealized += CalculateOrderProfit(transaction);
                    }
                    break;
                }
            }
        }
        return totalRealized;
    }

    // Map transaction status to icon color
    private Color GetStatusColor(TransactionStatus status)
    {
        return status switch
        {
            TransactionStatus.Completed => Color.Success,
            TransactionStatus.Pending => Color.Warning,
            TransactionStatus.Canceled => Color.Default,
            TransactionStatus.Refunded => Color.Secondary,
            _ => Color.Default
        };
    }

    // Update status via API and refresh cached data
    private async Task UpdateStatus(Transaction transaction, TransactionStatus newStatus)
    {
        if (transaction.Status == newStatus) return;

        try
        {
            var response = await Http.PutAsJsonAsync($"api/transactions/{transaction.Id}/status", newStatus);
            if (response.IsSuccessStatusCode)
            {
                transaction.Status = newStatus;
                Notify.Success($"Status updated to {newStatus}");
                await TransactionService.RefreshDataAsync(); // Refresh to update stock if needed
            }
            else
            {
                Notify.Error("Failed to update status");
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error: {ex.Message}");
        }
    }

    // Open delivery status dialog (optionally with payment)
    private async Task OpenStatusDialog(Transaction transaction)
    {
        var parameters = new DialogParameters { ["Transaction"] = transaction };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StatusUpdateDialog>($"Delivery Status #{transaction.Id}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is StatusUpdateDialog.StatusUpdateResult updateResult)
        {
            // 1. Update Status
            if (transaction.Status != updateResult.Status)
            {
                await UpdateStatus(transaction, updateResult.Status);
            }

            // 2. Process Payment if requested
            if (updateResult.AddPayment && updateResult.PaymentAmount > 0)
            {
                await ProcessPayment(transaction, updateResult.PaymentAmount, updateResult.PaymentMethod);
            }
        }
    }

    // Create a payment and persist via API
    private async Task ProcessPayment(Transaction transaction, decimal amount, string method)
    {
        try
        {
            var currentUser = await AuthStateProvider.GetCurrentUserAsync();
            var payment = new Payment
            {
                PaymentDate = DateTime.UtcNow,
                Amount = amount,
                PaymentMethod = method,
                CustomerName = transaction.CustomerName,
                EmployeeName = currentUser?.Name ?? "Unknown",
                PersonId = transaction.PersonId,
                Allocations = new List<PaymentAllocation>
                {
                    new PaymentAllocation
                    {
                        TransactionId = transaction.Id,
                        Amount = amount
                    }
                }
            };
            
            var response = await Http.PostAsJsonAsync("api/payments", payment);
            if (response.IsSuccessStatusCode)
            {
                Notify.Success("Payment recorded");
                await TransactionService.RefreshDataAsync();
                await LoadData();
            }
            else
            {
                Notify.Error("Failed to record payment");
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error recording payment: {ex.Message}");
        }
    }

    // Column width map for fixed layout table
    private string GetColumnWidth(string columnName)
    {
        return columnName switch
        {
            "Order" => "110px",
            "Date" => "18%",
            "Items" => "20%",
            "Quantity" => "6%",
            "Cost" => "8%",
            "Profit" => "8%",
            "Realized Profit" => "8%",
            "Total" => "12%",
            "Discount" => "8%",
            "Payment" => "8%",
            "Delivery" => "8%",
            "Driver" => "10%",
            "Customer" => "10%",
            "Note" => "10%",
            "Employee" => "8%",
            "Actions" => "5%",
            _ => "auto"
        };
    }
}
