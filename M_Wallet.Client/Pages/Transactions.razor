@page "/transactions"
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ReceiptService _receiptService
@inject CustomAuthenticationStateProvider AuthStateProvider
@using M_Wallet.Client.Models

<PageTitle>Transactions</PageTitle>

@if (transactions == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <!-- Filters Section -->
    <MudPaper Class="mb-4 pa-1" Elevation="2">
        
        <MudGrid Spacing="1" Class="align-center">
            <MudItem xs="6" sm="4" md="2">
                <MudDatePicker Label="From" 
                               @bind-Date="filterFromDate" 
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               MaxDate="@DateTime.Today" />
            </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudDatePicker Label="To" 
                                   @bind-Date="filterToDate" 
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Clearable="true"
                                   MaxDate="@DateTime.Today" />
                </MudItem>
                <MudItem xs="6" sm="4" md="2">
                    <MudAutocomplete T="Product" 
                                     Label="Product" 
                                     @bind-Value="selectedProductFilter"
                                     SearchFunc="@SearchProducts"
                                     ToStringFunc="@(p => p?.Name)"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="6" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Customer" 
                                     @bind-Value="filterCustomer"
                                     SearchFunc="@SearchCustomers"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="6" md="2">
                    <MudAutocomplete T="string" 
                                     Label="Employee" 
                                     @bind-Value="filterEmployee"
                                     SearchFunc="@SearchEmployees"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     ResetValueOnEmptyText="true"
                                     MaxItems="null"
                                     Virtualize="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="6" sm="2" md="1" Class="d-flex justify-center align-center">
                    <MudTooltip Text="Clear Filters">
                        <MudIconButton Icon="@Icons.Material.Filled.FilterAltOff" 
                                       Color="Color.Error" 
                                       OnClick="ClearFilters"
                                       Size="Size.Medium" />
                    </MudTooltip>
                </MudItem>
                <MudItem xs="6" sm="2" md="1" Class="d-flex justify-center align-center">
                    <MudTooltip Text="@(showProfit ? "Hide Profit" : "Show Profit")">
                        <MudIconButton Icon="@(showProfit ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" 
                                       Color="@(showProfit ? Color.Primary : Color.Default)" 
                                       OnClick="ToggleProfitVisibility"
                                       Size="Size.Medium" />
                    </MudTooltip>
                </MudItem>
                <MudItem xs="6" sm="2" md="1" Class="d-flex justify-center align-center">
                    <MudTooltip Text="View Statement">
                        <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" 
                                       Color="Color.Info" 
                                       OnClick="ShowCustomerStatement"
                                       Disabled="@(string.IsNullOrWhiteSpace(filterCustomer) || filterCustomer == "Walk-in")"
                                       Size="Size.Medium" />
                    </MudTooltip>
                </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0">
        <MudTabPanel Text="Sales History" Icon="@Icons.Material.Filled.Receipt">
            @if (FilteredTransactions.Count() != transactions.Count)
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                    Showing @FilteredTransactions.Count() of @transactions.Count transactions
                </MudAlert>
            }

            <MudPaper Class="pa-2" Elevation="0">
                <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
                    <MudTable Items="@FilteredTransactions" 
                              Hover="true" 
                              Dense="true" 
                              Breakpoint="Breakpoint.None"
                              Filter="new Func<Transaction, bool>(SearchFilter)"
                              @bind-SelectedItem="selectedTransaction"
                              SortLabel="Sort By"
                              RowStyleFunc="RowStyleFunc"
                              OnRowClick="OnRowClick"
                              T="Transaction">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Sales History</MudText>
                            <MudSpacer />
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary"
                                       StartIcon="@(expandAll ? Icons.Material.Filled.UnfoldLess : Icons.Material.Filled.UnfoldMore)"
                                       OnClick="ToggleExpandAll"
                                       Class="mr-2">
                                @(expandAll ? "Collapse All" : "Expand All")
                            </MudButton>
                            <MudTextField @bind-Value="searchString" 
                                          Placeholder="Search" 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search" 
                                          IconSize="Size.Medium" 
                                          Class="mt-0"
                                          Immediate="true">
                            </MudTextField>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh Style="width: 50px;"></MudTh>
                            @if (IsTransactionColumnVisible("Order ID")) { <MudTh><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<Transaction, object>(x => x.Id)">Order ID</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Date")) { <MudTh><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.TransactionDate)">Date</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Items")) { <MudTh>Items</MudTh> }
                            @if (IsTransactionColumnVisible("Quantity")) { <MudTh><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.Items.Sum(i => i.Quantity))">Quantity</MudTableSortLabel></MudTh> }
                            @if (showProfit)
                            {
                                <MudTh>Cost (LD)</MudTh>
                                <MudTh>Profit (LD)</MudTh>
                            }
                            @if (IsTransactionColumnVisible("Total")) { <MudTh><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.TotalAmount)">Total (LD)</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Status")) { <MudTh>Status</MudTh> }
                            @if (IsTransactionColumnVisible("Customer")) { <MudTh><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.CustomerName ?? string.Empty)">Customer</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Employee")) { <MudTh><MudTableSortLabel SortBy="new Func<Transaction, object>(x => x.EmployeeName)">Employee</MudTableSortLabel></MudTh> }
                            @if (IsTransactionColumnVisible("Actions")) { <MudTh>Actions</MudTh> }
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="">
                                <MudIcon Icon="@(expandedTransactions.Contains(context.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                         Size="Size.Small" />
                            </MudTd>
                            @if (IsTransactionColumnVisible("Order ID")) {
                                <MudTd DataLabel="Order ID">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" OnClick="@((e) => ShowPaymentHistory(context))" Style="cursor: pointer;">#@context.Id</MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Date")) { <MudTd DataLabel="Date">@context.TransactionDate.ToLocalTime().ToString("MM/dd/yy HH:mm")</MudTd> }
                            @if (IsTransactionColumnVisible("Items")) { <MudTd DataLabel="Items">@string.Join(", ", context.Items.Select(i => i.Product?.Name ?? "Unknown").Distinct())</MudTd> }
                            @if (IsTransactionColumnVisible("Quantity")) { <MudTd DataLabel="Quantity">@context.Items.Sum(i => i.Quantity)</MudTd> }
                            @if (showProfit)
                            {
                                <MudTd DataLabel="Cost">
                                    @{
                                        var cost = CalculateOrderCost(context);
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Info">
                                        @cost.ToString("F2")
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Profit">
                                    @{
                                        var profit = CalculateOrderProfit(context);
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="@(profit > 0 ? Color.Success : Color.Error)">
                                        @profit.ToString("F2")
                                    </MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Total")) {
                                <MudTd DataLabel="Total">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Success">
                                        @context.TotalAmount.ToString("F2")
                                    </MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Status")) {
                                <MudTd DataLabel="Status">
                                    @{
                                        var paid = context.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0;
                                        var status = "Unpaid";
                                        var color = Color.Error;
                                        if (paid >= context.TotalAmount - 0.01m) // Tolerance for float math
                                        { 
                                            status = "Paid"; 
                                            color = Color.Success; 
                                        }
                                        else if (paid > 0) 
                                        { 
                                            status = "Partial"; 
                                            color = Color.Warning; 
                                        }
                                    }
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@color" OnClick="@((e) => OpenPaymentDialog(context))" Style="cursor: pointer;">@status</MudChip>
                                </MudTd>
                            }
                            @if (IsTransactionColumnVisible("Customer")) { <MudTd DataLabel="Customer">@(context.CustomerName ?? "Walk-in")</MudTd> }
                            @if (IsTransactionColumnVisible("Employee")) { <MudTd DataLabel="Employee">@context.EmployeeName</MudTd> }
                            @if (IsTransactionColumnVisible("Actions")) {
                                <MudTd DataLabel="Actions">
                                    <MudMenu Icon="@Icons.Material.Filled.Print" Color="Color.Info" Size="Size.Small" Dense="true">
                                        <MudMenuItem OnClick="@(() => PrintReceipt(context))">Print Receipt (Thermal)</MudMenuItem>
                                        <MudMenuItem OnClick="@(() => PrintInvoice(context))">Print Invoice (A4)</MudMenuItem>
                                    </MudMenu>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                   Color="Color.Error" 
                                                   Size="Size.Small" 
                                                   OnClick="@(() => DeleteTransaction(context))" />
                                </MudTd>
                            }
                        </RowTemplate>
                        <ChildRowContent Context="trans">
                            @if (expandedTransactions.Contains(trans.Id))
                            {
                                <MudTr>
                                    <td colspan="10" class="pa-0">
                                        <MudCard Elevation="0" Class="pa-4 rounded-0" Style="background-color: var(--mud-palette-background-grey); border-left: 4px solid var(--mud-palette-primary); border-bottom: 1px solid var(--mud-palette-lines-default);">
                                            <MudTable Items="@trans.Items" 
                                                      Dense="true" 
                                                      Hover="true"
                                                      Elevation="0"
                                                      Breakpoint="Breakpoint.None"
                                                      Class="mud-table-compact">
                                                <HeaderContent>
                                                    <MudTh Class="pa-1">Product</MudTh>
                                                    <MudTh Class="pa-1">Qty</MudTh>
                                                    <MudTh Class="pa-1">Price</MudTh>
                                                    @if (showProfit)
                                                    {
                                                        <MudTh Class="pa-1">Cost</MudTh>
                                                        <MudTh Class="pa-1">Profit</MudTh>
                                                    }
                                                    <MudTh Class="pa-1">Total</MudTh>
                                                </HeaderContent>
                                                <RowTemplate Context="item">
                                                    <MudTd Class="pa-1">
                                                        <div class="d-flex align-center">
                                                            @if (item.Product != null)
                                                            {
                                                                <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                                               Color="Color.Default"
                                                                               Size="Size.Small"
                                                                               Class="mr-2"
                                                                               OnClick="@(() => ShowProductDetails(item.Product!))" />
                                                            }
                                                            @item.Product?.Name
                                                        </div>
                                                    </MudTd>
                                                    <MudTd Class="pa-1">@item.Quantity</MudTd>
                                                    <MudTd Class="pa-1">@item.UnitPrice.ToString("F2")</MudTd>
                                                    @if (showProfit)
                                                    {
                                                        <MudTd Class="pa-1">
                                                            <MudText Typo="Typo.body2" Color="Color.Info">
                                                                @(((item.UnitCost > 0 ? item.UnitCost : item.Product?.CostPrice ?? 0) * item.Quantity).ToString("F2"))
                                                            </MudText>
                                                        </MudTd>
                                                        <MudTd Class="pa-1">
                                                            @{
                                                                var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
                                                                var itemProfit = (item.UnitPrice - cost) * item.Quantity;
                                                            }
                                                            <MudText Typo="Typo.body2" Color="@(itemProfit > 0 ? Color.Success : Color.Error)">
                                                                <b>@itemProfit.ToString("F2")</b>
                                                            </MudText>
                                                        </MudTd>
                                                    }
                                                    <MudTd Class="pa-1">
                                                        <b>@item.Subtotal.ToString("F2")</b>
                                                    </MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </MudCard>
                                    </td>
                                </MudTr>
                            }
                        </ChildRowContent>
                        <PagerContent>
                            <div class="d-flex align-center justify-space-between px-4 py-2">
                                <TableColumnToggle Columns="@_transactionColumns" ColumnsChanged="StateHasChanged" TableName="Transactions" />
                                <MudTablePager />
                            </div>
                        </PagerContent>
                    </MudTable>
                </div>
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="Payment History" Icon="@Icons.Material.Filled.History">
            @if (payments == null)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                <MudTable Items="@FilteredPayments" Hover="true" Dense="true" Breakpoint="Breakpoint.None">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Payment History</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="paymentSearchString" 
                                      Placeholder="Search Payments" 
                                      Adornment="Adornment.Start" 
                                      AdornmentIcon="@Icons.Material.Filled.Search" 
                                      IconSize="Size.Medium" 
                                      Class="mt-0"
                                      Immediate="true">
                        </MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (IsPaymentColumnVisible("Payment ID")) { <MudTh>Payment ID</MudTh> }
                        @if (IsPaymentColumnVisible("Realized Profit")) { <MudTh>Realized Profit</MudTh> }
                        @if (IsPaymentColumnVisible("Date")) { <MudTh>Date</MudTh> }
                        @if (IsPaymentColumnVisible("Method")) { <MudTh Class="d-none d-sm-table-cell">Method</MudTh> }
                        @if (IsPaymentColumnVisible("Reference")) { <MudTh Class="d-none d-sm-table-cell">Reference</MudTh> }
                        @if (IsPaymentColumnVisible("Amount")) { <MudTh>Amount</MudTh> }
                        @if (IsPaymentColumnVisible("Allocations")) { <MudTh>Allocations</MudTh> }
                        @if (IsPaymentColumnVisible("Actions")) { <MudTh>Actions</MudTh> }
                    </HeaderContent>
                    <RowTemplate>
                        @if (IsPaymentColumnVisible("Payment ID")) { <MudTd DataLabel="Payment ID">#@context.Id</MudTd> }
                        @if (IsPaymentColumnVisible("Realized Profit")) {
                            <MudTd DataLabel="Realized Profit">
                                @{
                                    var realizedProfit = GetRealizedProfit(context);
                                }
                                @if (realizedProfit != 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@(realizedProfit > 0 ? Color.Success : Color.Error)">
                                        LD @realizedProfit.ToString("F2")
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                }
                            </MudTd>
                        }
                        @if (IsPaymentColumnVisible("Date")) { <MudTd DataLabel="Date">@context.PaymentDate.ToLocalTime().ToString("MM/dd/yy HH:mm")</MudTd> }
                        @if (IsPaymentColumnVisible("Method")) { <MudTd DataLabel="Method" Class="d-none d-sm-table-cell">@context.PaymentMethod</MudTd> }
                        @if (IsPaymentColumnVisible("Reference")) { <MudTd DataLabel="Reference" Class="d-none d-sm-table-cell">@context.Reference</MudTd> }
                        @if (IsPaymentColumnVisible("Amount")) {
                            <MudTd DataLabel="Amount">
                                <MudText Color="Color.Success" Class="font-weight-bold">
                                    LD @context.Amount.ToString("F2")
                                </MudText>
                            </MudTd>
                        }
                        @if (IsPaymentColumnVisible("Allocations")) {
                            <MudTd DataLabel="Allocations">
                                <MudText Typo="Typo.body2">
                                    @string.Join(", ", context.Allocations.Select(a => $"#{a.TransactionId}: {a.Amount:F2}"))
                                </MudText>
                            </MudTd>
                        }
                        @if (IsPaymentColumnVisible("Actions")) {
                            <MudTd DataLabel="Actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                               Color="Color.Error" 
                                               Size="Size.Small" 
                                               OnClick="@(() => DeletePayment(context))" />
                            </MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_paymentColumns" ColumnsChanged="StateHasChanged" TableName="TransactionPayments" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            }
        </MudTabPanel>

        <MudTabPanel Text="Outstanding Invoices" Icon="@Icons.Material.Filled.PendingActions">
            @{
                var unpaidTransactions = FilteredTransactions.Where(t => (t.TotalAmount - (t.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0)) > 0.01m).ToList();
            }
            @if (!unpaidTransactions.Any())
            {
                <MudAlert Severity="Severity.Success">No outstanding invoices matching filters!</MudAlert>
            }
            else
            {
                <MudTable Items="@unpaidTransactions" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Transaction, bool>(SearchFilter)">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Unpaid Invoices</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (IsInvoiceColumnVisible("Order ID")) { <MudTh>Order ID</MudTh> }
                        @if (IsInvoiceColumnVisible("Date")) { <MudTh>Date</MudTh> }
                        @if (IsInvoiceColumnVisible("Customer")) { <MudTh>Customer</MudTh> }
                        @if (IsInvoiceColumnVisible("Total")) { <MudTh>Total</MudTh> }
                        @if (IsInvoiceColumnVisible("Paid")) { <MudTh>Paid</MudTh> }
                        @if (IsInvoiceColumnVisible("Balance")) { <MudTh>Balance</MudTh> }
                        @if (IsInvoiceColumnVisible("Action")) { <MudTh>Action</MudTh> }
                    </HeaderContent>
                    <RowTemplate>
                        @if (IsInvoiceColumnVisible("Order ID")) { <MudTd DataLabel="Order ID">#@context.Id</MudTd> }
                        @if (IsInvoiceColumnVisible("Date")) { <MudTd DataLabel="Date">@context.TransactionDate.ToLocalTime().ToString("MM/dd/yy")</MudTd> }
                        @if (IsInvoiceColumnVisible("Customer")) { <MudTd DataLabel="Customer">@(context.CustomerName ?? "Walk-in")</MudTd> }
                        @if (IsInvoiceColumnVisible("Total")) { <MudTd DataLabel="Total">LD @context.TotalAmount.ToString("F2")</MudTd> }
                        @if (IsInvoiceColumnVisible("Paid")) { <MudTd DataLabel="Paid">LD @(context.PaymentAllocations?.Sum(pa => pa.Amount).ToString("F2") ?? "0.00")</MudTd> }
                        @if (IsInvoiceColumnVisible("Balance")) {
                            <MudTd DataLabel="Balance">
                                <MudText Color="Color.Error" Class="font-weight-bold">
                                    LD @((context.TotalAmount - (context.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0)).ToString("F2"))
                                </MudText>
                            </MudTd>
                        }
                        @if (IsInvoiceColumnVisible("Action")) {
                            <MudTd DataLabel="Action">
                                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="@(() => OpenPaymentDialog(context))">
                                    Pay
                                </MudButton>
                            </MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_invoiceColumns" ColumnsChanged="StateHasChanged" TableName="TransactionInvoices" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    private List<Transaction>? transactions;
    private List<Payment>? payments;
    private Transaction? selectedTransaction;
    private string searchString = "";
    private string paymentSearchString = "";
    private HashSet<int> expandedTransactions = new();
    private bool expandAll = false;
    private bool showProfit = false;

    private List<ColumnDefinition> _transactionColumns = new()
    {
        new() { Title = "Order ID", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Items", IsVisible = true },
        new() { Title = "Quantity", IsVisible = true },
        new() { Title = "Total", IsVisible = true },
        new() { Title = "Status", IsVisible = true },
        new() { Title = "Customer", IsVisible = true },
        new() { Title = "Employee", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _paymentColumns = new()
    {
        new() { Title = "Payment ID", IsVisible = true },
        new() { Title = "Realized Profit", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Method", IsVisible = true },
        new() { Title = "Reference", IsVisible = true },
        new() { Title = "Amount", IsVisible = true },
        new() { Title = "Allocations", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _invoiceColumns = new()
    {
        new() { Title = "Order ID", IsVisible = true },
        new() { Title = "Date", IsVisible = true },
        new() { Title = "Customer", IsVisible = true },
        new() { Title = "Total", IsVisible = true },
        new() { Title = "Paid", IsVisible = true },
        new() { Title = "Balance", IsVisible = true },
        new() { Title = "Action", IsVisible = true }
    };

    private bool IsTransactionColumnVisible(string title) => _transactionColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;
    private bool IsPaymentColumnVisible(string title) => _paymentColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;
    private bool IsInvoiceColumnVisible(string title) => _invoiceColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;


    // Filter variables
    private DateTime? filterFromDate;
    private DateTime? filterToDate;
    private Product? selectedProductFilter;
    private string? filterCustomer;
    private string? filterEmployee;

    private IEnumerable<Transaction> FilteredTransactions
    {
        get
        {
            if (transactions == null) return Enumerable.Empty<Transaction>();

            var filtered = transactions.AsEnumerable();

            // Date range filter
            if (filterFromDate.HasValue)
            {
                filtered = filtered.Where(t => t.TransactionDate.Date >= filterFromDate.Value.Date);
            }
            if (filterToDate.HasValue)
            {
                filtered = filtered.Where(t => t.TransactionDate.Date <= filterToDate.Value.Date);
            }

            // Product filter
            if (selectedProductFilter != null)
            {
                filtered = filtered.Where(t => t.Items.Any(i => i.ProductId == selectedProductFilter.Id));
            }

            // Customer filter
            if (!string.IsNullOrWhiteSpace(filterCustomer))
            {
                if (filterCustomer == "Walk-in")
                {
                    filtered = filtered.Where(t => string.IsNullOrWhiteSpace(t.CustomerName));
                }
                else
                {
                    filtered = filtered.Where(t => t.CustomerName == filterCustomer);
                }
            }

            // Employee filter
            if (!string.IsNullOrWhiteSpace(filterEmployee))
            {
                filtered = filtered.Where(t => t.EmployeeName == filterEmployee);
            }

            return filtered;
        }
    }

    private IEnumerable<Payment> FilteredPayments
    {
        get
        {
            if (payments == null) return Enumerable.Empty<Payment>();

            var filtered = payments.AsEnumerable();

            // Date range filter
            if (filterFromDate.HasValue)
            {
                filtered = filtered.Where(p => p.PaymentDate.Date >= filterFromDate.Value.Date);
            }
            if (filterToDate.HasValue)
            {
                filtered = filtered.Where(p => p.PaymentDate.Date <= filterToDate.Value.Date);
            }

            // Customer filter
            if (!string.IsNullOrWhiteSpace(filterCustomer))
            {
                if (filterCustomer == "Walk-in")
                {
                    filtered = filtered.Where(p => string.IsNullOrWhiteSpace(p.CustomerName));
                }
                else
                {
                    filtered = filtered.Where(p => p.CustomerName == filterCustomer);
                }
            }

            // Search filter
            if (!string.IsNullOrWhiteSpace(paymentSearchString))
            {
                filtered = filtered.Where(p => 
                    p.Id.ToString().Contains(paymentSearchString) ||
                    (p.CustomerName ?? "Walk-in").Contains(paymentSearchString, StringComparison.OrdinalIgnoreCase) ||
                    (p.Reference ?? "").Contains(paymentSearchString, StringComparison.OrdinalIgnoreCase) ||
                    p.Amount.ToString().Contains(paymentSearchString) ||
                    p.Allocations.Any(a => a.TransactionId.ToString().Contains(paymentSearchString))
                );
            }

            return filtered.OrderByDescending(p => p.PaymentDate);
        }
    }

    private bool SearchFilter(Transaction transaction)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (transaction.Id.ToString().Contains(searchString))
            return true;
        if (transaction.EmployeeName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if ((transaction.CustomerName ?? "Walk-in").Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (transaction.TotalAmount.ToString().Contains(searchString))
            return true;
        if (transaction.Items.Any(i => i.Product?.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false))
            return true;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            // Load Transactions
            transactions = await Http.GetFromJsonAsync<List<Transaction>>("api/transactions");
            
            // Load Payments (we need a way to get all payments, or we can extract them from transactions if the API supports it, 
            // but usually a separate endpoint is better. Let's assume we can get them.)
            try 
            {
                payments = await Http.GetFromJsonAsync<List<Payment>>("api/payments");
            }
            catch
            {
                // Fallback or handle if endpoint doesn't exist yet
                payments = new List<Payment>();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private string RowStyleFunc(Transaction transaction, int index)
    {
        if (expandedTransactions.Contains(transaction.Id))
        {
            return "background-color: rgba(var(--mud-palette-primary-rgb), 0.08);";
        }
        return string.Empty;
    }

    private void OnRowClick(TableRowClickEventArgs<Transaction> args)
    {
        if (args.Item != null)
        {
            ToggleExpanded(args.Item.Id);
        }
    }

    private void ToggleExpanded(int transactionId)
    {
        if (expandedTransactions.Contains(transactionId))
        {
            expandedTransactions.Remove(transactionId);
        }
        else
        {
            expandedTransactions.Add(transactionId);
        }
    }

    private void ToggleExpandAll()
    {
        expandAll = !expandAll;
        
        if (expandAll)
        {
            // Expand all visible transactions
            if (transactions != null)
            {
                expandedTransactions = FilteredTransactions.Select(t => t.Id).ToHashSet();
            }
        }
        else
        {
            // Collapse all transactions
            expandedTransactions.Clear();
        }
    }

    private void ClearFilters()
    {
        filterFromDate = null;
        filterToDate = null;
        selectedProductFilter = null;
        filterCustomer = null;
        filterEmployee = null;
    }

    private void ToggleProfitVisibility()
    {
        showProfit = !showProfit;
    }

    private decimal CalculateOrderCost(Transaction transaction)
    {
        return transaction.Items.Sum(item => 
            (item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0)) * item.Quantity);
    }

    private decimal CalculateOrderProfit(Transaction transaction)
    {
        if (transaction.Items == null) return 0;
        return transaction.Items.Sum(item =>
        {
            var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
            return (item.UnitPrice - cost) * item.Quantity;
        });
    }

    private Task<IEnumerable<Product>> SearchProducts(string value, CancellationToken token)
    {
        var products = GetUniqueProducts();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? products 
            : products.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private Task<IEnumerable<string>> SearchCustomers(string value, CancellationToken token)
    {
        var customers = GetUniqueCustomers();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? customers 
            : customers.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private List<Product> GetUniqueProducts()
    {
        if (transactions == null) return new();

        return transactions
            .SelectMany(t => t.Items)
            .Where(i => i.Product != null)
            .Select(i => i.Product!)
            .GroupBy(p => p.Id)
            .Select(g => g.First())
            .OrderBy(p => p.Name)
            .ToList();
    }

    private List<string> GetUniqueCustomers()
    {
        if (transactions == null) return new();

        return transactions
            .Select(t => string.IsNullOrWhiteSpace(t.CustomerName) ? "Walk-in" : t.CustomerName)
            .Distinct()
            .OrderBy(c => c)
            .ToList();
    }

    private List<string> GetUniqueEmployees()
    {
        if (transactions == null) return new();

        return transactions
            .Select(t => t.EmployeeName)
            .Distinct()
            .OrderBy(e => e)
            .ToList();
    }

    private Task<IEnumerable<string>> SearchEmployees(string value, CancellationToken token)
    {
        var employees = GetUniqueEmployees();
        return Task.FromResult(string.IsNullOrEmpty(value) 
            ? employees 
            : employees.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task OpenPaymentDialog(Transaction transaction)
    {
        var paid = transaction.PaymentAllocations?.Sum(pa => pa.Amount) ?? 0;
        var balance = transaction.TotalAmount - paid;

        var parameters = new DialogParameters 
        { 
            ["TransactionId"] = transaction.Id,
            ["BalanceDue"] = balance,
            ["CustomerName"] = transaction.CustomerName
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PaymentDialog>("Process Payment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task ShowPaymentHistory(Transaction transaction)
    {
        var parameters = new DialogParameters { ["Transaction"] = transaction };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PaymentHistoryDialog>($"Payment History - Order #{transaction.Id}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task ShowProductDetails(Product product)
    {
        var parameters = new DialogParameters { ["Product"] = product };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<ProductDetailsDialog>(product.Name, parameters, options);
    }

    private async Task PrintReceipt(Transaction transaction)
    {
        var html = _receiptService.GenerateReceiptHtml(transaction);
        await JSRuntime.InvokeVoidAsync("printer.printHtml", html);
    }

    private async Task PrintInvoice(Transaction transaction)
    {
        var html = _receiptService.GenerateInvoiceHtml(transaction);
        await JSRuntime.InvokeVoidAsync("printer.printHtml", html);
    }

    private async Task DeleteTransaction(Transaction transaction)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Transaction", 
            $"Are you sure you want to delete Order #{transaction.Id}? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var currentUser = await AuthStateProvider.GetCurrentUserAsync();
                var employeeName = currentUser?.Name ?? "Unknown";
                var response = await Http.DeleteAsync($"api/transactions/{transaction.Id}?employeeName={Uri.EscapeDataString(employeeName)}");
                
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Transaction deleted", Severity.Success);
                    await LoadData();
                }
                else
                {
                    Snackbar.Add("Failed to delete transaction", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeletePayment(Payment payment)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Payment", 
            $"Are you sure you want to delete Payment #{payment.Id} (LD {payment.Amount:F2})? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/payments/{payment.Id}");
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Payment deleted", Severity.Success);
                    await LoadData();
                }
                else
                {
                    Snackbar.Add("Failed to delete payment", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private decimal GetRealizedProfit(Payment payment)
    {
        decimal totalRealizedProfit = 0;
        if (payment.Allocations == null || !payment.Allocations.Any()) return 0;

        foreach (var allocation in payment.Allocations)
        {
            var transaction = allocation.Transaction;
            if (transaction == null || transaction.Items == null || !transaction.Items.Any()) continue;

            // Find all payments for this transaction from the payments list
            var allPaymentsForTransaction = payments?
                .Where(p => p.Allocations != null && p.Allocations.Any(a => a.TransactionId == transaction.Id))
                .OrderBy(p => p.PaymentDate)
                .ToList();

            if (allPaymentsForTransaction == null || !allPaymentsForTransaction.Any()) continue;

            // Calculate cumulative paid amount up to and including this payment
            decimal cumulative = 0;
            bool isCompletingPayment = false;

            foreach (var p in allPaymentsForTransaction)
            {
                var allocationAmount = p.Allocations.FirstOrDefault(a => a.TransactionId == transaction.Id)?.Amount ?? 0;
                cumulative += allocationAmount;

                if (p.Id == payment.Id)
                {
                    // This payment completes the transaction if cumulative reaches total
                    if (cumulative >= transaction.TotalAmount - 0.01m)
                    {
                        isCompletingPayment = true;
                    }
                    break;
                }
            }

            if (isCompletingPayment)
            {
                totalRealizedProfit += CalculateOrderProfit(transaction);
            }
        }
        return totalRealizedProfit;
    }

    private async Task ShowCustomerStatement()
    {
        if (string.IsNullOrWhiteSpace(filterCustomer) || filterCustomer == "Walk-in") return;

        var items = new List<StatementItem>();

        // Debits: Sales (Transactions)
        var customerTransactions = transactions?
            .Where(t => t.CustomerName == filterCustomer)
            .ToList() ?? new List<Transaction>();

        items.AddRange(customerTransactions.Select(t => new StatementItem
        {
            Date = t.TransactionDate,
            Description = $"Invoice #{t.Id}",
            Amount = -t.TotalAmount // Debt increases (negative balance from customer perspective? Or positive?)
            // Let's stick to: Positive = Money In (Payment), Negative = Money Out (Purchase/Invoice)
            // So Invoice is Negative (Owed), Payment is Positive (Paid).
            // Balance: Negative means they owe us.
        }));

        // Credits: Payments
        var customerPayments = payments?
            .Where(p => p.CustomerName == filterCustomer)
            .ToList() ?? new List<Payment>();

        items.AddRange(customerPayments.Select(p => new StatementItem
        {
            Date = p.PaymentDate,
            Description = $"Payment #{p.Id} ({p.PaymentMethod})",
            Amount = p.Amount
        }));

        // Sort and Calculate Running Balance
        items = items.OrderBy(i => i.Date).ToList();
        decimal balance = 0;
        foreach (var item in items)
        {
            balance += item.Amount;
            item.RunningBalance = balance;
        }

        var parameters = new DialogParameters();
        parameters.Add("Items", items.OrderByDescending(i => i.Date).ToList());
        parameters.Add("Title", $"Statement of Account - {filterCustomer}");

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        await DialogService.ShowAsync<FinancialStatementDialog>($"Statement - {filterCustomer}", parameters, options);
    }
}
