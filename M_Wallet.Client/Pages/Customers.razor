@page "/customers"
@using M_Wallet.Shared
@using M_Wallet.Client.Components
@using M_Wallet.Client.Models
@using MudBlazor
@using System.Text.Json
@inject HttpClient Http
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Customers</PageTitle>

<MudTable Items="@customers" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Customer, bool>(FilterFunc)">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Customers</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Sync" OnClick="SyncCustomers" Class="ml-4">Sync History</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddCustomer" Class="ml-4">Add Customer</MudButton>
    </ToolBarContent>
    <HeaderContent>
        @if (IsVisible("Name")) { <MudTh>Name</MudTh> }
        @if (IsVisible("Phone Number")) { <MudTh>Phone Number</MudTh> }
        @if (IsVisible("Actions")) { <MudTh>Actions</MudTh> }
    </HeaderContent>
    <RowTemplate>
        @if (IsVisible("Name")) { <MudTd DataLabel="Name">@context.Name</MudTd> }
        @if (IsVisible("Phone Number")) { <MudTd DataLabel="Phone Number">@context.PhoneNumber</MudTd> }
        @if (IsVisible("Actions")) {
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditCustomer(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Color="Color.Info" Size="Size.Small" OnClick="@(() => ShowStatement(context))" Title="Statement" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteCustomer(context))" />
            </MudTd>
        }
    </RowTemplate>
    <PagerContent>
        <div class="d-flex align-center justify-space-between px-4 py-2">
            <TableColumnToggle Columns="@_columns" ColumnsChanged="StateHasChanged" TableName="Customers" />
            <MudTablePager />
        </div>
    </PagerContent>
</MudTable>

@code {
    private List<Customer> customers = new();
    private string searchString = "";

    private List<ColumnDefinition> _columns = new()
    {
        new() { Title = "Name", IsVisible = true },
        new() { Title = "Phone Number", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private bool IsVisible(string title) => _columns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            customers = await Http.GetFromJsonAsync<List<Customer>>("api/customers") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading customers: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterFunc(Customer customer)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (customer.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (customer.PhoneNumber != null && customer.PhoneNumber.Contains(searchString))
            return true;
        return false;
    }

    private async Task SyncCustomers()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Sync Customers", 
            "This will scan all past transactions and create customer profiles for any names that don't exist in the list. It will also link transactions to these profiles.\n\nDo you want to continue?", 
            yesText: "Sync", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var response = await Http.PostAsync("api/customers/sync", null);
                if (response.IsSuccessStatusCode)
                {
                    var stats = await response.Content.ReadFromJsonAsync<JsonElement>();
                    int added = stats.GetProperty("added").GetInt32();
                    int linked = stats.GetProperty("linkedTransactions").GetInt32();
                    
                    Snackbar.Add($"Sync Complete: Added {added} customers, Linked {linked} transactions.", Severity.Success);
                    await LoadCustomers();
                }
                else
                {
                    Snackbar.Add("Sync failed.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error syncing: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddCustomer()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CustomerDialog>("Add Customer", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data != null)
        {
            var newCustomer = (Customer)result.Data;
            var response = await Http.PostAsJsonAsync("api/customers", newCustomer);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Customer added", Severity.Success);
                await LoadCustomers();
            }
            else
            {
                Snackbar.Add("Failed to add customer", Severity.Error);
            }
        }
    }

    private async Task EditCustomer(Customer customer)
    {
        var parameters = new DialogParameters { ["Customer"] = new Customer { Id = customer.Id, Name = customer.Name, PhoneNumber = customer.PhoneNumber } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CustomerDialog>("Edit Customer", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data != null)
        {
            var updatedCustomer = (Customer)result.Data;
            var response = await Http.PutAsJsonAsync($"api/customers/{customer.Id}", updatedCustomer);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Customer updated", Severity.Success);
                await LoadCustomers();
            }
            else
            {
                Snackbar.Add("Failed to update customer", Severity.Error);
            }
        }
    }

    private async Task DeleteCustomer(Customer customer)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Customer", 
            $"Are you sure you want to delete {customer.Name}?", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            var response = await Http.DeleteAsync($"api/customers/{customer.Id}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Customer deleted", Severity.Success);
                await LoadCustomers();
            }
            else
            {
                Snackbar.Add("Failed to delete customer", Severity.Error);
            }
        }
    }

    private async Task ShowStatement(Customer customer)
    {
        try
        {
            var items = await Http.GetFromJsonAsync<List<StatementItem>>($"api/customers/{customer.Id}/statement") ?? new();
            
            var parameters = new DialogParameters();
            parameters.Add("Items", items);
            parameters.Add("Title", $"Statement - {customer.Name}");

            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

            await DialogService.ShowAsync<FinancialStatementDialog>($"Statement - {customer.Name}", parameters, options);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading statement: {ex.Message}", Severity.Error);
        }
    }
}
