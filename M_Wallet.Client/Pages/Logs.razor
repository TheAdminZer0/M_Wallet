@page "/logs"
@inject HttpClient Http
@using M_Wallet.Shared
@using MudBlazor
@using M_Wallet.Client.Components
@using M_Wallet.Client.Models

<PageTitle>Audit Logs</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Audit Logs</MudText>
<MudText Class="mb-4">Track all system activities and employee actions.</MudText>

<div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
    <MudTable Items="@logs" Dense="true" Hover="true" Bordered="true" Striped="true" Breakpoint="Breakpoint.None" Filter="new Func<AuditLog,bool>(FilterFunc1)" Loading="@isLoading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">System Logs</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString" Placeholder="Search logs..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            @if (IsVisible("Time")) { <MudTh>Time</MudTh> }
            @if (IsVisible("Action")) { <MudTh>Action</MudTh> }
            @if (IsVisible("Entity")) { <MudTh>Entity</MudTh> }
            @if (IsVisible("Employee")) { <MudTh>Employee</MudTh> }
            @if (IsVisible("Description")) { <MudTh>Description</MudTh> }
        </HeaderContent>
        <RowTemplate>
            @if (IsVisible("Time")) { <MudTd DataLabel="Time" Style="white-space: nowrap;">@context.Timestamp.ToLocalTime().ToString("yyyy/MM/dd hh:mm tt")</MudTd> }
            @if (IsVisible("Action")) {
                <MudTd DataLabel="Action">
                    <MudChip T="string" Color="@GetColor(context.Action)" Size="Size.Small">@context.Action</MudChip>
                </MudTd>
            }
            @if (IsVisible("Entity")) { <MudTd DataLabel="Entity">@context.Entity</MudTd> }
            @if (IsVisible("Employee")) { <MudTd DataLabel="Employee">@context.EmployeeName</MudTd> }
            @if (IsVisible("Description")) { <MudTd DataLabel="Description">@context.Description</MudTd> }
        </RowTemplate>
        <PagerContent>
            <div class="d-flex align-center justify-space-between px-4 py-2">
                <TableColumnToggle Columns="@_columns" ColumnsChanged="StateHasChanged" TableName="Logs" />
                <MudTablePager />
            </div>
        </PagerContent>
    </MudTable>
</div>

@code {
    private List<AuditLog> logs = new();
    private string searchString = "";
    private bool isLoading = true;

    private List<ColumnDefinition> _columns = new()
    {
        new() { Title = "Time", IsVisible = true },
        new() { Title = "Action", IsVisible = true },
        new() { Title = "Entity", IsVisible = true },
        new() { Title = "Employee", IsVisible = true },
        new() { Title = "Description", IsVisible = true }
    };

    private bool IsVisible(string title) => _columns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            logs = await Http.GetFromJsonAsync<List<AuditLog>>("api/logs") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool FilterFunc1(AuditLog element) => FilterFunc(element, searchString);

    private bool FilterFunc(AuditLog element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.Action.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Entity.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.EmployeeName != null && element.EmployeeName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Description != null && element.Description.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private Color GetColor(string action)
    {
        return action switch
        {
            "Create" => Color.Success,
            "Update" => Color.Warning,
            "Delete" => Color.Error,
            "Sale" => Color.Primary,
            _ => Color.Default
        };
    }
}
