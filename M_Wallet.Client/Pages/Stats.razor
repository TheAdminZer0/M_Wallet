@page "/stats"
@inject HttpClient Http
@inject ISnackbar Snackbar
@using M_Wallet.Shared
@using System.Globalization

<PageTitle>Statistics & Analytics</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Statistics & Analytics</MudText>
<MudText Class="mb-4">Overview of sales, profits, and business insights</MudText>

@if (isLoading)
{
    <div class="d-flex justify-center pa-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else if (transactions == null || !transactions.Any())
{
    <MudAlert Severity="Severity.Info">No transaction data available yet.</MudAlert>
}
else
{
    <!-- Summary Cards -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Sales</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold">LD @TotalSales.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Large" Color="Color.Success" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Profit</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold" Color="Color.Success">LD @TotalProfit.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Success" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Orders</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold">@transactions.Count</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Info" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Items Sold</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold">@TotalItemsSold</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Color="Color.Warning" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Avg Order Value</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold">LD @AverageOrderValue.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Large" Color="Color.Primary" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Profit Margin</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold">@ProfitMargin.ToString("F1")%</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Percent" Size="Size.Large" Color="Color.Success" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Today's Sales</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold">LD @TodaySales.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Large" Color="Color.Info" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Today's Profit</MudText>
                            <MudText Typo="Typo.h5" Class="font-weight-bold" Color="Color.Success">LD @TodayProfit.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Large" Color="Color.Success" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Charts Row -->
    <MudGrid Spacing="3">
        <!-- Daily Profit Chart (Last 30 Days) -->
        <MudItem xs="12" lg="8">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Daily Profit (Last 30 Days)</MudText>
                <MudChart ChartType="ChartType.Bar" 
                          ChartSeries="@dailyProfitSeries" 
                          XAxisLabels="@dailyLabels"
                          Width="100%" 
                          Height="350px"
                          ChartOptions="@chartOptions" />
            </MudPaper>
        </MudItem>

        <!-- Monthly Overview -->
        <MudItem xs="12" lg="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">This Month</MudText>
                <MudStack Spacing="3">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Sales</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-bold">LD @ThisMonthSales.ToString("N2")</MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Profit</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Success">LD @ThisMonthProfit.ToString("N2")</MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Orders</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-bold">@ThisMonthOrders</MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Profit Margin</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-bold">@ThisMonthMargin.ToString("F1")%</MudText>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Monthly Profit Trend (Last 12 Months) -->
        <MudItem xs="12" lg="8">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Monthly Profit Trend</MudText>
                <MudChart ChartType="ChartType.Line" 
                          ChartSeries="@monthlyProfitSeries" 
                          XAxisLabels="@monthlyLabels"
                          Width="100%" 
                          Height="350px"
                          ChartOptions="@chartOptions" />
            </MudPaper>
        </MudItem>

        <!-- Top Products -->
        <MudItem xs="12" lg="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Top Profitable Products</MudText>
                <MudList T="string" Dense="true">
                    @foreach (var item in TopProducts.Take(5))
                    {
                        <MudListItem T="string">
                            <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                <div>
                                    <MudText Typo="Typo.body2" Class="font-weight-bold">@item.ProductName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@item.Quantity sold  LD @item.Revenue.ToString("N2") sales</MudText>
                                </div>
                                <MudText Typo="Typo.body2" Color="Color.Success" Class="font-weight-bold">
                                    LD @item.Profit.ToString("N2")
                                </MudText>
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private List<Transaction>? transactions;
    private List<Product>? products;
    private List<Payment>? payments;
    private bool isLoading = true;

    // Summary metrics
    private decimal TotalSales => payments?.Sum(p => p.Amount) ?? 0;
    private decimal TotalProfit => CalculateTotalProfit();
    private int TotalItemsSold => transactions?.Sum(t => t.Items.Sum(i => i.Quantity)) ?? 0;
    private decimal AverageOrderValue => transactions?.Any() == true ? (transactions.Sum(t => t.TotalAmount) / transactions.Count) : 0;
    private decimal ProfitMargin => TotalSales > 0 ? (TotalProfit / TotalSales) * 100 : 0;
    
    private decimal TodaySales => payments?
        .Where(p => p.PaymentDate.Date == DateTime.UtcNow.Date)
        .Sum(p => p.Amount) ?? 0;
    
    private decimal TodayProfit => CalculateProfitFromPayments(payments?
        .Where(p => p.PaymentDate.Date == DateTime.UtcNow.Date)
        .ToList());

    private decimal ThisMonthSales => payments?
        .Where(p => p.PaymentDate.Month == DateTime.UtcNow.Month && p.PaymentDate.Year == DateTime.UtcNow.Year)
        .Sum(p => p.Amount) ?? 0;
    
    private decimal ThisMonthProfit => CalculateProfitFromPayments(payments?
        .Where(p => p.PaymentDate.Month == DateTime.UtcNow.Month && p.PaymentDate.Year == DateTime.UtcNow.Year)
        .ToList());
    
    private int ThisMonthOrders => transactions?
        .Count(t => t.TransactionDate.Month == DateTime.UtcNow.Month && t.TransactionDate.Year == DateTime.UtcNow.Year) ?? 0;
    
    private decimal ThisMonthMargin => ThisMonthSales > 0 ? (ThisMonthProfit / ThisMonthSales) * 100 : 0;

    // Chart data
    private List<ChartSeries> dailyProfitSeries = new();
    private string[] dailyLabels = Array.Empty<string>();
    
    private List<ChartSeries> monthlyProfitSeries = new();
    private string[] monthlyLabels = Array.Empty<string>();

    private ChartOptions chartOptions = new()
    {
        YAxisTicks = 5,
        MaxNumYAxisTicks = 10,
        YAxisFormat = "N0"
    };

    // Top products
    private List<TopProductData> TopProducts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            transactions = await Http.GetFromJsonAsync<List<Transaction>>("api/transactions");
            products = await Http.GetFromJsonAsync<List<Product>>("api/products");
            payments = await Http.GetFromJsonAsync<List<Payment>>("api/payments");
            
            if (transactions != null && products != null && payments != null)
            {
                PrepareChartData();
                CalculateTopProducts();
            }
        }
        catch (Exception)
        {
            // Handle error silently
        }
        finally
        {
            isLoading = false;
        }
    }

    private decimal CalculateTotalProfit()
    {
        return CalculateProfitFromPayments(payments);
    }

    private decimal CalculateProfitFromPayments(List<Payment>? paymentList)
    {
        if (paymentList == null || !paymentList.Any() || transactions == null || products == null) return 0;

        decimal totalProfit = 0;
        foreach (var payment in paymentList)
        {
            foreach (var allocation in payment.Allocations)
            {
                var transaction = transactions.FirstOrDefault(t => t.Id == allocation.TransactionId);
                if (transaction != null && transaction.TotalAmount > 0)
                {
                    decimal transactionProfit = 0;
                    foreach (var item in transaction.Items)
                    {
                        var product = products.FirstOrDefault(p => p.Id == item.ProductId);
                        if (product != null)
                        {
                            transactionProfit += (item.UnitPrice - product.CostPrice) * item.Quantity;
                        }
                    }
                    
                    var profitShare = (allocation.Amount / transaction.TotalAmount) * transactionProfit;
                    totalProfit += profitShare;
                }
            }
        }
        return totalProfit;
    }

    private void PrepareChartData()
    {
        if (payments == null || transactions == null || products == null) return;

        // Daily profit for last 30 days
        var dailyData = new Dictionary<DateTime, decimal>();
        var startDate = DateTime.UtcNow.Date.AddDays(-29);
        
        for (int i = 0; i < 30; i++)
        {
            var date = startDate.AddDays(i);
            var dayPayments = payments.Where(p => p.PaymentDate.Date == date).ToList();
            dailyData[date] = CalculateProfitFromPayments(dayPayments);
        }

        dailyLabels = dailyData.Keys.Select(d => d.ToString("MM/dd")).ToArray();
        dailyProfitSeries = new List<ChartSeries>
        {
            new ChartSeries 
            { 
                Name = "Daily Profit", 
                Data = dailyData.Values.Select(v => (double)v).ToArray() 
            }
        };

        // Monthly profit for last 12 months
        var monthlyData = new Dictionary<DateTime, decimal>();
        var startMonth = DateTime.UtcNow.Date.AddMonths(-11);
        startMonth = new DateTime(startMonth.Year, startMonth.Month, 1);

        for (int i = 0; i < 12; i++)
        {
            var month = startMonth.AddMonths(i);
            var monthPayments = payments
                .Where(p => p.PaymentDate.Year == month.Year && p.PaymentDate.Month == month.Month)
                .ToList();
            monthlyData[month] = CalculateProfitFromPayments(monthPayments);
        }

        monthlyLabels = monthlyData.Keys.Select(d => d.ToString("MMM yyyy")).ToArray();
        monthlyProfitSeries = new List<ChartSeries>
        {
            new ChartSeries 
            { 
                Name = "Monthly Profit", 
                Data = monthlyData.Values.Select(v => (double)v).ToArray() 
            }
        };
    }

    private void CalculateTopProducts()
    {
        if (payments == null || transactions == null || products == null) return;

        var productStats = new Dictionary<int, TopProductData>();

        // 1. Calculate Quantity (Accrual - physical movement)
        foreach (var transaction in transactions)
        {
            foreach (var item in transaction.Items)
            {
                if (!productStats.ContainsKey(item.ProductId))
                {
                    var product = products.FirstOrDefault(p => p.Id == item.ProductId);
                    productStats[item.ProductId] = new TopProductData
                    {
                        ProductId = item.ProductId,
                        ProductName = product?.Name ?? "Unknown",
                        Quantity = 0,
                        Revenue = 0,
                        Profit = 0
                    };
                }
                productStats[item.ProductId].Quantity += item.Quantity;
            }
        }

        // 2. Calculate Revenue and Profit (Cash Basis)
        foreach (var payment in payments)
        {
            foreach (var allocation in payment.Allocations)
            {
                var transaction = transactions.FirstOrDefault(t => t.Id == allocation.TransactionId);
                if (transaction != null && transaction.TotalAmount > 0)
                {
                    var ratio = allocation.Amount / transaction.TotalAmount;

                    foreach (var item in transaction.Items)
                    {
                        if (productStats.ContainsKey(item.ProductId))
                        {
                            var itemRevenue = item.Subtotal * ratio;
                            
                            var product = products.FirstOrDefault(p => p.Id == item.ProductId);
                            var itemProfit = product != null 
                                ? (item.UnitPrice - product.CostPrice) * item.Quantity 
                                : 0;
                            var profitShare = itemProfit * ratio;

                            productStats[item.ProductId].Revenue += itemRevenue;
                            productStats[item.ProductId].Profit += profitShare;
                        }
                    }
                }
            }
        }

        TopProducts = productStats.Values
            .OrderByDescending(p => p.Profit)
            .ToList();
    }

    private class TopProductData
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; } = "";
        public int Quantity { get; set; }
        public decimal Revenue { get; set; }
        public decimal Profit { get; set; }
    }
}
