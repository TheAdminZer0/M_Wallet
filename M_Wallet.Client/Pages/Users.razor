@page "/users"
@using M_Wallet.Shared
@using M_Wallet.Client.Components
@using M_Wallet.Client.Models
@using MudBlazor
@inject HttpClient Http
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Users</PageTitle>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="Customers" Icon="@Icons.Material.Filled.People">
        <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
            <MudTable Items="@GetUsersByRole("Customer")" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Person, bool>(FilterFunc)" SortLabel="Sort By">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Customers</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => AddUser("Customer"))" Class="ml-4">Add Customer</MudButton>
                </ToolBarContent>
                <HeaderContent>
                    @if (IsCustomerColumnVisible("Name")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Name)">Name</MudTableSortLabel></MudTh> }
                    @if (IsCustomerColumnVisible("Phone Number")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.PhoneNumber)">Phone Number</MudTableSortLabel></MudTh> }
                    @if (IsCustomerColumnVisible("Balance")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Balance)">Balance</MudTableSortLabel></MudTh> }
                    @if (IsCustomerColumnVisible("Last Transaction")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.LastTransactionDate)">Last Transaction</MudTableSortLabel></MudTh> }
                    @if (IsCustomerColumnVisible("Actions")) { <MudTh>Actions</MudTh> }
                </HeaderContent>
                <RowTemplate>
                    @if (IsCustomerColumnVisible("Name")) { <MudTd DataLabel="Name">@context.Name</MudTd> }
                    @if (IsCustomerColumnVisible("Phone Number")) { <MudTd DataLabel="Phone Number">@context.PhoneNumber</MudTd> }
                    @if (IsCustomerColumnVisible("Balance")) { 
                        <MudTd DataLabel="Balance">
                            <MudText Color="@(context.Balance < 0 ? Color.Error : Color.Success)">
                                @context.Balance.ToString("F2")
                            </MudText>
                        </MudTd> 
                    }
                    @if (IsCustomerColumnVisible("Last Transaction")) { <MudTd DataLabel="Last Transaction" Style="white-space: nowrap;">@(context.LastTransactionDate?.ToLocalTime().ToString("yyyy/MM/dd hh:mm tt") ?? "-")</MudTd> }
                    @if (IsCustomerColumnVisible("Actions")) {
                        <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditUser(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" Size="Size.Small" OnClick="@(() => OpenPaymentDialog(context))" Title="Payment" />
                            <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Color="Color.Info" Size="Size.Small" OnClick="@(() => ShowStatement(context))" Title="Statement" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteUser(context))" />
                        </MudTd>
                    }
                </RowTemplate>
                <PagerContent>
                    <div class="d-flex align-center justify-space-between px-4 py-2">
                        <TableColumnToggle Columns="@_customerColumns" ColumnsChanged="StateHasChanged" TableName="UsersCustomers" />
                        <MudTablePager />
                    </div>
                </PagerContent>
            </MudTable>
        </div>
    </MudTabPanel>

    <MudTabPanel Text="Drivers" Icon="@Icons.Material.Filled.LocalShipping">
        <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
            <MudTable Items="@GetUsersByRole("Driver")" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Person, bool>(FilterFunc)" SortLabel="Sort By">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Drivers</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => AddUser("Driver"))" Class="ml-4">Add Driver</MudButton>
                </ToolBarContent>
                <HeaderContent>
                    @if (IsDriverColumnVisible("Name")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Name)">Name</MudTableSortLabel></MudTh> }
                    @if (IsDriverColumnVisible("Phone Number")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.PhoneNumber)">Phone Number</MudTableSortLabel></MudTh> }
                    @if (IsDriverColumnVisible("Deliveries")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.CompletedDeliveries)">Deliveries</MudTableSortLabel></MudTh> }
                    @if (IsDriverColumnVisible("Balance")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Balance)">Balance</MudTableSortLabel></MudTh> }
                    @if (IsDriverColumnVisible("Last Transaction")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.LastTransactionDate)">Last Transaction</MudTableSortLabel></MudTh> }
                    @if (IsDriverColumnVisible("Actions")) { <MudTh>Actions</MudTh> }
                </HeaderContent>
                <RowTemplate>
                    @if (IsDriverColumnVisible("Name")) { <MudTd DataLabel="Name">@context.Name</MudTd> }
                    @if (IsDriverColumnVisible("Phone Number")) { <MudTd DataLabel="Phone Number">@context.PhoneNumber</MudTd> }
                    @if (IsDriverColumnVisible("Deliveries")) {
                        <MudTd DataLabel="Deliveries">
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">@context.CompletedDeliveries</MudChip>
                        </MudTd>
                    }
                    @if (IsDriverColumnVisible("Balance")) { 
                        <MudTd DataLabel="Balance">
                            <MudText Color="@(context.Balance < 0 ? Color.Error : Color.Success)">
                                @context.Balance.ToString("F2")
                            </MudText>
                        </MudTd> 
                    }
                    @if (IsDriverColumnVisible("Last Transaction")) { <MudTd DataLabel="Last Transaction" Style="white-space: nowrap;">@(context.LastTransactionDate?.ToLocalTime().ToString("yyyy/MM/dd hh:mm tt") ?? "-")</MudTd> }
                    @if (IsDriverColumnVisible("Actions")) {
                        <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditUser(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Color="Color.Info" Size="Size.Small" OnClick="@(() => ShowStatement(context))" Title="Statement" />
                            <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" Color="Color.Warning" Size="Size.Small" OnClick="@(() => ShowDeliveries(context))" Title="Deliveries" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteUser(context))" />
                        </MudTd>
                    }
                </RowTemplate>
                <PagerContent>
                    <div class="d-flex align-center justify-space-between px-4 py-2">
                        <TableColumnToggle Columns="@_driverColumns" ColumnsChanged="StateHasChanged" TableName="UsersDrivers" />
                        <MudTablePager />
                    </div>
                </PagerContent>
            </MudTable>
        </div>
    </MudTabPanel>

    <MudTabPanel Text="System" Icon="@Icons.Material.Filled.Computer">
        @if (isAdminVerified)
        {
            <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
                <MudTable Items="@GetUsersByRole("System")" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Person, bool>(FilterFunc)" SortLabel="Sort By">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">System Accounts</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => AddUser("System"))" Class="ml-4">Add System User</MudButton>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Name)">Name</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Role)">Role</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Username)">Username</MudTableSortLabel></MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="systemContext">
                        <MudTd DataLabel="Name">@systemContext.Name</MudTd>
                        <MudTd DataLabel="Role">@systemContext.Role</MudTd>
                        <MudTd DataLabel="Username">@systemContext.Username</MudTd>
                        <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditUser(systemContext))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteUser(systemContext))" />
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </div>
        }
        else
        {
            <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
                <MudText Typo="Typo.h5" Class="mb-4">Admin Access Required</MudText>
                <MudText Class="mb-6">Please enter Admin Pattern to view system accounts.</MudText>
                <PatternAuthComponent OnAuthorized="OnAdminAuthorized" />
            </MudPaper>
        }
    </MudTabPanel>

    <MudTabPanel Text="Employees" Icon="@Icons.Material.Filled.Badge">
        @if (isAdminVerified)
        {
            <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
                <MudTable Items="@GetUsersByRole("Employee")" Hover="true" Dense="true" Breakpoint="Breakpoint.None" Filter="new Func<Person, bool>(FilterFunc)" SortLabel="Sort By">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Employees</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => AddUser("Employee"))" Class="ml-4">Add Employee</MudButton>
                    </ToolBarContent>
                    <HeaderContent>
                        @if (IsEmployeeColumnVisible("Name")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Name)">Name</MudTableSortLabel></MudTh> }
                        @if (IsEmployeeColumnVisible("Role")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Role)">Role</MudTableSortLabel></MudTh> }
                        @if (IsEmployeeColumnVisible("Username")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Username)">Username</MudTableSortLabel></MudTh> }
                        @if (IsEmployeeColumnVisible("Passcode")) { <MudTh>Passcode</MudTh> }
                        @if (IsEmployeeColumnVisible("Balance")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.Balance)">Balance</MudTableSortLabel></MudTh> }
                        @if (IsEmployeeColumnVisible("Last Transaction")) { <MudTh><MudTableSortLabel SortBy="new Func<Person, object>(x => x.LastTransactionDate)">Last Transaction</MudTableSortLabel></MudTh> }
                        @if (IsEmployeeColumnVisible("Actions")) { <MudTh>Actions</MudTh> }
                    </HeaderContent>
                    <RowTemplate Context="employeeContext">
                        @if (IsEmployeeColumnVisible("Name")) { <MudTd DataLabel="Name">@employeeContext.Name</MudTd> }
                        @if (IsEmployeeColumnVisible("Role")) { <MudTd DataLabel="Role">@employeeContext.Role</MudTd> }
                        @if (IsEmployeeColumnVisible("Username")) { <MudTd DataLabel="Username">@employeeContext.Username</MudTd> }
                        @if (IsEmployeeColumnVisible("Passcode")) { <MudTd DataLabel="Passcode">@employeeContext.Passcode</MudTd> }
                        @if (IsEmployeeColumnVisible("Balance")) { 
                            <MudTd DataLabel="Balance">
                                <MudText Color="@(employeeContext.Balance < 0 ? Color.Error : Color.Success)">
                                    @employeeContext.Balance.ToString("F2")
                                </MudText>
                            </MudTd> 
                        }
                        @if (IsEmployeeColumnVisible("Last Transaction")) { <MudTd DataLabel="Last Transaction" Style="white-space: nowrap;">@(employeeContext.LastTransactionDate?.ToLocalTime().ToString("yyyy/MM/dd hh:mm tt") ?? "-")</MudTd> }
                        @if (IsEmployeeColumnVisible("Actions")) {
                            <MudTd DataLabel="Actions" Style="white-space: nowrap;">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditUser(employeeContext))" />
                                <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Color="Color.Info" Size="Size.Small" OnClick="@(() => ShowStatement(employeeContext))" Title="Statement" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteUser(employeeContext))" />
                            </MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        <div class="d-flex align-center justify-space-between px-4 py-2">
                            <TableColumnToggle Columns="@_employeeColumns" ColumnsChanged="StateHasChanged" TableName="UsersEmployees" />
                            <MudTablePager />
                        </div>
                    </PagerContent>
                </MudTable>
            </div>
        }
        else
        {
            <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
                <MudText Typo="Typo.h5" Class="mb-4">Admin Access Required</MudText>
                <MudText Class="mb-6">Please enter Admin Pattern to view employees.</MudText>
                <PatternAuthComponent OnAuthorized="OnAdminAuthorized" />
            </MudPaper>
        }
    </MudTabPanel>
</MudTabs>

@code {
    private List<Person> users = new();
    private string searchString = "";
    private bool isAdminVerified = false;

    private List<ColumnDefinition> _customerColumns = new()
    {
        new() { Title = "Name", IsVisible = true },
        new() { Title = "Phone Number", IsVisible = true },
        new() { Title = "Balance", IsVisible = true },
        new() { Title = "Last Transaction", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _driverColumns = new()
    {
        new() { Title = "Name", IsVisible = true },
        new() { Title = "Phone Number", IsVisible = true },
        new() { Title = "Deliveries", IsVisible = true },
        new() { Title = "Balance", IsVisible = true },
        new() { Title = "Last Transaction", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private List<ColumnDefinition> _employeeColumns = new()
    {
        new() { Title = "Name", IsVisible = true },
        new() { Title = "Role", IsVisible = true },
        new() { Title = "Username", IsVisible = true },
        new() { Title = "Passcode", IsVisible = true },
        new() { Title = "Balance", IsVisible = true },
        new() { Title = "Last Transaction", IsVisible = true },
        new() { Title = "Actions", IsVisible = true }
    };

    private bool IsCustomerColumnVisible(string title) => _customerColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;
    private bool IsDriverColumnVisible(string title) => _driverColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;
    private bool IsEmployeeColumnVisible(string title) => _employeeColumns.FirstOrDefault(c => c.Title == title)?.IsVisible ?? true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.IsInRole("Admin"))
        {
            isAdminVerified = true;
        }
    }

    private void OnAdminAuthorized(Person person)
    {
        if (person.Role == "Admin")
        {
            isAdminVerified = true;
            Snackbar.Add("Access Granted", Severity.Success);
        }
        else
        {
            Snackbar.Add("Access Denied: Not an Admin", Severity.Error);
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            users = await Http.GetFromJsonAsync<List<Person>>("api/people") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
    }

    private IEnumerable<Person> GetUsersByRole(string role)
    {
        if (role == "Employee")
        {
            return users.Where(u => u.Role == "Employee" || u.Role == "Admin");
        }
        return users.Where(u => u.Role == role);
    }

    private bool FilterFunc(Person user)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (user.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (user.PhoneNumber != null && user.PhoneNumber.Contains(searchString))
            return true;
        return false;
    }

    private async Task AddUser(string role)
    {
        var parameters = new DialogParameters { ["Role"] = role };
        var dialog = DialogService.Show<UserDialog>($"Add {role}", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsers();
        }
    }

    private async Task EditUser(Person user)
    {
        var parameters = new DialogParameters { ["User"] = user, ["Role"] = user.Role };
        var dialog = DialogService.Show<UserDialog>($"Edit {user.Role}", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsers();
        }
    }

    private async Task DeleteUser(Person user)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete User", 
            $"Are you sure you want to delete {user.Name}?", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            var response = await Http.DeleteAsync($"api/people/{user.Id}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("User deleted", Severity.Success);
                await LoadUsers();
            }
            else
            {
                Snackbar.Add("Error deleting user", Severity.Error);
            }
        }
    }

    private async Task OpenPaymentDialog(Person person)
    {
        var parameters = new DialogParameters();
        parameters.Add("Person", person);

        var dialog = await DialogService.ShowAsync<CustomerPaymentDialog>("Customer Payment", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadUsers();
        }
    }

    private async Task ShowStatement(Person user)
    {
        try
        {
            var items = await Http.GetFromJsonAsync<List<StatementItem>>($"api/people/{user.Id}/statement");
            var parameters = new DialogParameters { ["Items"] = items, ["Title"] = $"Statement - {user.Name}" };
            DialogService.Show<FinancialStatementDialog>($"Statement: {user.Name}", parameters, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading statement: {ex.Message}", Severity.Error);
        }
    }

    private void ShowDeliveries(Person user)
    {
        Snackbar.Add("Delivery stats coming soon!", Severity.Info);
    }
}
