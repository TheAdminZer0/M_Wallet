@page "/products"
@inject HttpClient Http
@inject NotificationService Notify
@inject IDialogService DialogService
@inject ProductService ProductService

<PageTitle>Product Management</PageTitle>

<!-- Product catalog management with search, barcode scan, and column toggles -->

@if (products == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (!products.Any())
{
    <div class="d-flex flex-column align-center gap-4 mt-4">
        <MudAlert Severity="Severity.Info">No products found. Add your first product to get started!</MudAlert>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialog">Add First Product</MudButton>
    </div>
}
else
{
    <MudPaper Class="pa-2 mb-4 mt-4" Elevation="2">
        <div class="d-flex align-center gap-2">
            <MudIconButton Icon="@Icons.Material.Filled.CenterFocusStrong"
                           Color="Color.Primary"
                           Size="Size.Medium"
                           Title="Scan barcode to search"
                           OnClick="OpenSearchScannerAsync" />
            <MudTextField Value="searchString" 
                          ValueChanged="@(EventCallback.Factory.Create<string>(this, OnSearchChanged))"
                          Placeholder="Search products..." 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium" 
                          Margin="Margin.Dense"
                          Clearable="true"
                          Immediate="true"
                          Style="max-width: 300px;">
            </MudTextField>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenAddDialog"
                       Size="Size.Small"
                       Class="ml-2">
                New Product
            </MudButton>
        </div>
    </MudPaper>

    <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
        <MudTable Items="@products" 
                  Hover="true" 
                  Dense="true" 
                  Breakpoint="Breakpoint.None"
                  Filter="new Func<Product, bool>(FilterFunc)"
                  SortLabel="Sort By"
                  RowStyleFunc="RowStyleFunc">
            <HeaderContent>
                @if (_productColumns.IsVisible("Actions")) { <MudTh Class="py-1 px-2">Actions</MudTh> }
                @if (_productColumns.IsVisible("Name")) { <MudTh Class="py-1 px-2"><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Product, object>(x => x.Name)">Name</MudTableSortLabel></MudTh> }
                @if (_productColumns.IsVisible("Barcode")) { <MudTh Class="py-1 px-2">Barcode</MudTh> }
                @if (_productColumns.IsVisible("Description")) { <MudTh Class="py-1 px-2">Description</MudTh> }
                @if (_productColumns.IsVisible("Cost")) { <MudTh Class="py-1 px-2"><MudTableSortLabel SortBy="new Func<Product, object>(x => x.CostPrice)">Cost (LD)</MudTableSortLabel></MudTh> }
                @if (_productColumns.IsVisible("Price")) { <MudTh Class="py-1 px-2"><MudTableSortLabel SortBy="new Func<Product, object>(x => x.Price)">Price (LD)</MudTableSortLabel></MudTh> }
                @if (_productColumns.IsVisible("Profit")) { <MudTh Class="py-1 px-4"><MudTableSortLabel SortBy="new Func<Product, object>(x => x.Price - x.CostPrice)">Profit (LD)</MudTableSortLabel></MudTh> }
                @if (_productColumns.IsVisible("Total Sold")) { <MudTh Class="py-1 px-2"><MudTableSortLabel SortBy="new Func<Product, object>(x => x.TotalSoldQuantity)">Total Sold</MudTableSortLabel></MudTh> }
                @if (_productColumns.IsVisible("Stock")) { <MudTh Class="py-1 px-2"><MudTableSortLabel SortBy="new Func<Product, object>(x => x.StockQuantity)">Stock</MudTableSortLabel></MudTh> }
                @if (_productColumns.IsVisible("Pinned")) { <MudTh Class="py-1 px-2"><MudTableSortLabel SortBy="new Func<Product, object>(x => x.IsPinned)">Pinned</MudTableSortLabel></MudTh> }
            </HeaderContent>
            <RowTemplate>
                @if (_productColumns.IsVisible("Actions")) {
                    <MudTd Class="py-1 px-2" Style="white-space: nowrap;">
                        <div class="d-flex">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteProduct(context))" />
                        </div>
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Name")) {
                    <MudTd Class="py-1 px-2">
                        <div class="d-flex align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Info"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           Class="mr-2"
                                           OnClick="@(() => ShowProductDetails(context))" />
                            <TruncatedText Text="@context.Name" MaxLength="25" DialogTitle="Product Name" />
                        </div>
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Barcode")) {
                    <MudTd Class="py-1 px-2">
                        @if (context.Barcodes.Any())
                        {
                            <MudTooltip Text="@string.Join(", ", context.Barcodes.Select(b => b.Barcode))">
                                <div class="d-flex gap-1 align-center">
                                    <MudChip T="string" Text="@context.Barcodes.First().Barcode" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" />
                                    @if (context.Barcodes.Count > 1)
                                    {
                                        <MudChip T="string" Text="@($"+{context.Barcodes.Count - 1}")" Size="Size.Small" Variant="Variant.Outlined" />
                                    }
                                </div>
                            </MudTooltip>
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Description")) { <MudTd Class="py-1 px-2"><TruncatedText Text="@context.Description" MaxLength="30" DialogTitle="Description" /></MudTd> }
                @if (_productColumns.IsVisible("Cost")) {
                    <MudTd Class="py-1 px-2">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.CostPrice.ToString("F2")</MudChip>
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Price")) {
                    <MudTd Class="py-1 px-2">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Success">@context.Price.ToString("F2")</MudChip>
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Profit")) {
                    <MudTd Class="py-1 px-4">
                        @{
                            var profit = context.Price - context.CostPrice;
                            var markup = context.CostPrice > 0 ? (profit / context.CostPrice) * 100 : 100;
                        }
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="@(profit > 0 ? Color.Info : Color.Error)" Title="Markup %">
                            @profit.ToString("F2") (@markup.ToString("F0")%)
                        </MudChip>
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Total Sold")) { <MudTd Class="py-1 px-2">@context.TotalSoldQuantity</MudTd> }
                @if (_productColumns.IsVisible("Stock")) {
                    <MudTd Class="py-1 px-2">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="@(context.StockQuantity > 10 ? Color.Success : Color.Warning)">
                            @(context.IsStockless ? "8" : context.StockQuantity)
                        </MudChip>
                    </MudTd>
                }
                @if (_productColumns.IsVisible("Pinned")) {
                    <MudTd Class="py-1 px-2">
                        <MudCheckBox T="bool" Value="@context.IsPinned" ValueChanged="@((bool val) => TogglePin(context, val))" Color="Color.Warning" CheckedIcon="@Icons.Material.Filled.PushPin" UncheckedIcon="@Icons.Material.Outlined.PushPin" Size="Size.Small" />
                    </MudTd>
                }
            </RowTemplate>
            <PagerContent>
                <div class="d-flex align-center justify-space-between px-4 py-2">
                    <TableColumnToggle Columns="@_productColumns" ColumnsChanged="StateHasChanged" TableName="Products" />
                    <MudTablePager />
                </div>
            </PagerContent>
        </MudTable>
    </div>
}

@code {
    private List<Product>? products;
    private IDialogReference? currentDialog;
    private IDialogReference? _searchScannerDialog;
    private string searchString = "";

    private List<ColumnDefinition> _productColumns = new()
    {
        new() { Title = "Actions", IsVisible = true },
        new() { Title = "Name", IsVisible = true },
        new() { Title = "Barcode", IsVisible = true },
        new() { Title = "Description", IsVisible = true },
        new() { Title = "Cost", IsVisible = true },
        new() { Title = "Price", IsVisible = true },
        new() { Title = "Profit", IsVisible = true },
        new() { Title = "Total Sold", IsVisible = true },
        new() { Title = "Stock", IsVisible = true },
        new() { Title = "Pinned", IsVisible = true }
    };

    private bool FilterFunc(Product product)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (product.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (product.Description?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
            return true;
        if (product.Barcodes.Any(b => b.Barcode.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
            return true;
        if (product.Price.ToString().Contains(searchString))
            return true;
        if (product.StockQuantity.ToString().Contains(searchString))
            return true;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await ProductService.RefreshDataAsync();
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            products = await ProductService.GetProductsAsync();
        }
        catch (Exception ex)
        {
            Notify.Error($"Error loading products: {ex.Message}");
        }
    }

    // Dialog helpers for add/edit details
    private async Task OpenAddDialog()
    {
        var product = new Product();
        
        var parameters = new DialogParameters<M_Wallet.Client.Components.ProductDialog>
        {
            { x => x.Product, product },
            { x => x.IsEditMode, false },
            { x => x.OnSubmit, EventCallback.Factory.Create<Product>(this, async (p) => {
                await SaveProduct(p);
                currentDialog?.Close();
            })},
            { x => x.OnCancel, EventCallback.Factory.Create(this, () => currentDialog?.Close()) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        currentDialog = await DialogService.ShowAsync<M_Wallet.Client.Components.ProductDialog>("Add Product", parameters, options);
    }

    private async Task OpenEditDialog(Product product)
    {
        var editProduct = new Product
        {
            Id = product.Id,
            Name = product.Name,
            Description = product.Description,
            CostPrice = product.CostPrice,
            Price = product.Price,
            StockQuantity = product.StockQuantity,
            ImageUrl = product.ImageUrl,
            IsActive = product.IsActive,
            IsStockless = product.IsStockless,
            IsService = product.IsService,
            IsPinned = product.IsPinned,
            Barcodes = product.Barcodes
                .Select(b => new ProductBarcode
                {
                    Id = b.Id,
                    Barcode = b.Barcode,
                    ProductId = b.ProductId,
                    CreatedAt = b.CreatedAt
                })
                .ToList()
        };
        
        var parameters = new DialogParameters<M_Wallet.Client.Components.ProductDialog>
        {
            { x => x.Product, editProduct },
            { x => x.IsEditMode, true },
            { x => x.OnSubmit, EventCallback.Factory.Create<Product>(this, async (p) => {
                await UpdateProduct(p);
                currentDialog?.Close();
            })},
            { x => x.OnCancel, EventCallback.Factory.Create(this, () => currentDialog?.Close()) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        currentDialog = await DialogService.ShowAsync<M_Wallet.Client.Components.ProductDialog>("Edit Product", parameters, options);
    }

    private async Task SaveProduct(Product product)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/products", product);

            if (response.IsSuccessStatusCode)
            {
                Notify.Success("Product added successfully!");
                await ProductService.RefreshDataAsync();
                await LoadProducts();
            }
            else
            {
                Notify.Error("Failed to add product");
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error: {ex.Message}");
        }
    }

    private async Task UpdateProduct(Product product)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/products/{product.Id}", product);

            if (response.IsSuccessStatusCode)
            {
                Notify.Success("Product updated successfully!");
                await ProductService.RefreshDataAsync();
                await LoadProducts();
            }
            else
            {
                Notify.Error("Failed to update product");
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error: {ex.Message}");
        }
    }

    private async Task TogglePin(Product product, bool isPinned)
    {
        product.IsPinned = isPinned;
        try
        {
            var response = await Http.PutAsJsonAsync($"api/products/{product.Id}", product);
            if (response.IsSuccessStatusCode)
            {
                Notify.Success(isPinned ? "Product pinned" : "Product unpinned");
            }
            else
            {
                product.IsPinned = !isPinned;
                Notify.Error("Failed to update pin status");
            }
        }
        catch (Exception ex)
        {
            product.IsPinned = !isPinned;
            Notify.Error($"Error: {ex.Message}");
        }
    }

    private async Task DeleteProduct(Product product)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Product", 
            $"Are you sure you want to delete '{product.Name}'? This cannot be undone.", 
            yesText: "Delete", cancelText: "Cancel");

        if (result != true)
            return;

        try
        {
            var response = await Http.DeleteAsync($"api/products/{product.Id}");

            if (response.IsSuccessStatusCode)
            {
                Notify.Success("Product deleted successfully");
                await ProductService.RefreshDataAsync();
                await LoadProducts();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Notify.Error($"Failed to delete product: {error}");
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error: {ex.Message}");
        }
    }

    private async Task ShowProductDetails(Product product)
    {
        var parameters = new DialogParameters
        { 
            { "Product", product }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<M_Wallet.Client.Components.ProductDetailsDialog>("Product Details", parameters, options);
    }

    private void OnSearchChanged(string value)
    {
        searchString = value;
    }

    private async Task OpenSearchScannerAsync()
    {
        var parameters = new DialogParameters<M_Wallet.Client.Components.BarcodeScannerDialog>
        {
            { x => x.OnDetected, EventCallback.Factory.Create<string>(this, HandleSearchBarcodeDetectedAsync) },
            { x => x.OnCancel, EventCallback.Factory.Create(this, CloseSearchScannerAsync) }
        };

        var options = new DialogOptions
        {
            FullScreen = true,
            CloseButton = true
        };

        _searchScannerDialog = await DialogService.ShowAsync<M_Wallet.Client.Components.BarcodeScannerDialog>("Scan Product", parameters, options);
    }

    private async Task HandleSearchBarcodeDetectedAsync(string code)
    {
        if (!string.IsNullOrWhiteSpace(code))
        {
            searchString = code;
            Notify.Info($"Searching for barcode {code}");
        }

        await CloseSearchScannerAsync();
    }

    private Task CloseSearchScannerAsync()
    {
        _searchScannerDialog?.Close();
        _searchScannerDialog = null;
        return Task.CompletedTask;
    }

    private string RowStyleFunc(Product product, int index)
    {
        if (!product.IsActive)
        {
            return "background-color: var(--mud-palette-error-hover);";
        }
        return "";
    }
}
