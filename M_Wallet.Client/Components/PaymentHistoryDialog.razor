@inject HttpClient Http
@inject NotificationService Notify
@inject IDialogService DialogService

@* Payment allocations history for a transaction *@
<MudDialog>
    <DialogContent>
        @if (Transaction.PaymentAllocations == null || !Transaction.PaymentAllocations.Any())
        {
            <MudAlert Severity="Severity.Info">No payments recorded for this order.</MudAlert>
        }
        else
        {
            @* Payment list with delete actions *@
            <MudTable Items="@Transaction.PaymentAllocations.OrderByDescending(pa => pa.Payment?.PaymentDate)" Dense="true" Hover="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh>Realized Profit</MudTh>
                    <MudTh>Method</MudTh>
                    <MudTh>Reference</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd Style="white-space: nowrap;">@(context.Payment?.PaymentDate.ToLocalTime().ToString("g") ?? "-")</MudTd>
                    <MudTd>
                        @if (context.Amount < 0)
                        {
                            <MudText Color="Color.Error" Class="font-weight-bold">@context.Amount.ToString("F2") (Refund)</MudText>
                        }
                        else
                        {
                            <MudText>@context.Amount.ToString("F2")</MudText>
                        }
                    </MudTd>
                    <MudTd>
                        @{
                            var realizedProfit = GetAllocationRealizedProfit(context);
                        }
                        @if (realizedProfit != 0)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="@(realizedProfit > 0 ? Color.Success : Color.Error)">
                                @realizedProfit.ToString("F2")
                            </MudChip>
                        }
                        else
                        {
                            <MudText Color="Color.Default">-</MudText>
                        }
                    </MudTd>
                    <MudTd><TruncatedText Text="@(context.Payment?.PaymentMethod ?? "-")" MaxLength="15" DialogTitle="Payment Method" /></MudTd>
                    <MudTd><TruncatedText Text="@(context.Payment?.Reference ?? "-")" MaxLength="20" DialogTitle="Reference" /></MudTd>
                    <MudTd Style="white-space: nowrap;">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small" 
                                       OnClick="@(() => DeletePayment(context))" />
                    </MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);"></MudTh>
                    <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@Transaction.PaymentAllocations.Sum(pa => pa.Amount).ToString("F2")</MudTh>
                    <MudTh Style="font-weight: bold; background: var(--mud-palette-background-gray);">@GetTotalRealizedProfit().ToString("F2")</MudTh>
                    <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh>
                    <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh>
                    <MudTh Style="background: var(--mud-palette-background-gray);"></MudTh>
                </FooterContent>
            </MudTable>
            <div class="d-flex justify-end mt-4 gap-4">
                <MudText Typo="Typo.subtitle1"><b>Total Amount:</b> @Transaction.TotalAmount.ToString("F2")</MudText>
                <MudText Typo="Typo.subtitle1" Color="@(Balance > 0 ? Color.Error : Color.Success)"><b>Balance:</b> @Balance.ToString("F2")</MudText>
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Transaction Transaction { get; set; } = default!;

    private decimal Balance => Transaction.BalanceDue;

    private void Close() => MudDialog.Close(DialogResult.Ok(true));

    // Recompute profit for the transaction
    private decimal CalculateOrderProfit()
    {
        if (Transaction.Items == null) return 0;
        var grossProfit = Transaction.Items.Sum(item =>
        {
            var cost = item.UnitCost > 0 ? item.UnitCost : (item.Product?.CostPrice ?? 0);
            return (item.UnitPrice - cost) * item.Quantity;
        });
        return grossProfit - Transaction.Discount;
    }

    // Get realized profit for a specific allocation
    private decimal GetAllocationRealizedProfit(PaymentAllocation allocation)
    {
        if (Transaction.PaymentAllocations == null || !Transaction.PaymentAllocations.Any())
            return 0;

        var orderProfit = CalculateOrderProfit();
        
        // For refund payments (negative amounts), return negative profit
        if (allocation.Amount < 0)
        {
            return -orderProfit;
        }

        // For regular payments, check if this allocation completes the order
        if (IsCompletingPayment(allocation))
        {
            return orderProfit;
        }

        return 0;
    }

    // Get total realized profit across all allocations
    private decimal GetTotalRealizedProfit()
    {
        if (Transaction.PaymentAllocations == null || !Transaction.PaymentAllocations.Any())
            return 0;

        return Transaction.PaymentAllocations.Sum(pa => GetAllocationRealizedProfit(pa));
    }

    // Determine if this allocation closes the balance (only for positive payments)
    private bool IsCompletingPayment(PaymentAllocation allocation)
    {
        if (Transaction.PaymentAllocations == null || !Transaction.PaymentAllocations.Any())
            return false;

        // Refund payments don't complete an order
        if (allocation.Amount < 0)
            return false;

        var sortedPayments = Transaction.PaymentAllocations
            .Where(pa => pa != null && pa.Amount > 0) // Only consider positive payments
            .OrderBy(pa => pa.Payment?.PaymentDate ?? DateTime.MinValue)
            .ToList();

        decimal cumulative = 0;
        foreach (var pa in sortedPayments)
        {
            cumulative += pa.Amount;

            if (cumulative >= Transaction.TotalAmount - 0.01m)
            {
                return pa.Id == allocation.Id;
            }
        }

        return false;
    }

    // Delete a payment allocation via API
    private async Task DeletePayment(PaymentAllocation allocation)
    {
        if (allocation.Payment == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Delete Payment", 
            $"Are you sure you want to delete this payment of LD {allocation.Amount:F2}?", 
            yesText: "Delete", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/payments/{allocation.Payment.Id}");
                if (response.IsSuccessStatusCode)
                {
                    Notify.Success("Payment deleted successfully");
                    Transaction.PaymentAllocations.Remove(allocation);
                    StateHasChanged();
                }
                else
                {
                    Notify.Error("Failed to delete payment");
                }
            }
            catch (Exception ex)
            {
                Notify.Error($"Error: {ex.Message}");
            }
        }
    }
}
