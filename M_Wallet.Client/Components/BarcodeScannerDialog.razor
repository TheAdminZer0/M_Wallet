@page "/BarcodeScanner"
@using MudBlazor
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@implements IAsyncDisposable

@* Camera scanner surface used both as page and dialog *@
<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4">
    <MudPaper Class="pa-4" Elevation="3">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h5">Camera Scanner</MudText>

            @* Camera selector when multiple devices are available *@
            @if (_devices.Count > 1)
            {
                <MudSelect T="string"
                           Label="Camera"
                           Dense="true"
                           Value="_selectedDeviceId"
                           ValueChanged="OnCameraChanged"
                           Immediate="true">
                    @foreach (var device in _devices)
                    {
                        <MudSelectItem Value="@device.DeviceId">@device.Label</MudSelectItem>
                    }
                </MudSelect>
            }

            <video id="@_videoElementId"
                   autoplay
                   playsinline
                   muted
                   style="width:100%;height:auto;border-radius:12px;background-color:#000;"></video>

            <MudText Typo="Typo.body2" Color="Color.Secondary">@_statusMessage</MudText>
            
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="CancelAsync" Class="mt-4">Cancel</MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public EventCallback<string> OnDetected { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    // Distinguish dialog usage (callbacks) from standalone page
    private bool _isDialogMode => OnDetected.HasDelegate;

    private readonly string _videoElementId = $"barcode-video-{Guid.NewGuid():N}";
    private DotNetObjectReference<BarcodeScannerDialog>? _dotNetRef;
    private readonly List<CameraDevice> _devices = new();
    private string? _selectedDeviceId;
    private string _statusMessage = "Initializing camera…";

    // Initialize camera list and start scanning on first render
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _dotNetRef = DotNetObjectReference.Create(this);

        try
        {
            var devices = await JSRuntime.InvokeAsync<List<CameraDevice>>("barcodeScanner.getDevices");
            _devices.Clear();
            _devices.AddRange(devices);
            _selectedDeviceId ??= GetPreferredCameraDeviceId();

            if (_selectedDeviceId is null)
            {
                _statusMessage = "No cameras detected.";
            }
            else
            {
                await StartScannerAsync();
            }
        }
        catch (JSException ex)
        {
            _statusMessage = ex.Message;
        }
        catch (Exception ex)
        {
            _statusMessage = ex.Message;
        }

        StateHasChanged();
    }

    // Start JS-side camera scanning for the selected device
    private async Task StartScannerAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedDeviceId))
        {
            return;
        }

        _statusMessage = "Point your camera at a barcode…";
        StateHasChanged();

        try
        {
            await JSRuntime.InvokeVoidAsync("barcodeScanner.start", _videoElementId, _dotNetRef, new { deviceId = _selectedDeviceId });
        }
        catch (JSException ex)
        {
            _statusMessage = ex.Message;
            StateHasChanged();
        }
    }

    private async Task OnCameraChanged(string? deviceId)
    {
        _selectedDeviceId = deviceId;
        await RestartScannerAsync();
    }

    // Restart with a different camera
    private async Task RestartScannerAsync()
    {
        await StopScannerAsync();
        await StartScannerAsync();
    }

    // Stop video stream in JS
    private async Task StopScannerAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("barcodeScanner.stop", _videoElementId);
        }
        catch (JSException)
        {
        }
    }

    [JSInvokable]
    // JS callback when a barcode is decoded
    public async Task OnBarcodeDetected(string code)
    {
        if (string.IsNullOrWhiteSpace(code))
        {
            return;
        }

        await StopScannerAsync();
        Snackbar.Add($"Barcode captured: {code}", Severity.Success);
        
        if (_isDialogMode)
        {
            await OnDetected.InvokeAsync(code);
        }
        else
        {
            // If used as a standalone page, navigate back or do something with the code
            // For now, let's just go back, assuming the user wanted to scan something for the previous page
            // In a real app, you might want to pass the code via query string or a service
             NavigationManager.NavigateTo($"/?scan={Uri.EscapeDataString(code)}");
        }
    }

    // Close dialog or navigate back without result
    private async Task CancelAsync()
    {
        await StopScannerAsync();
        if (_isDialogMode)
        {
            await OnCancel.InvokeAsync();
        }
        else
        {
            GoBack();
        }
    }
    
    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }

    // Cleanup camera stream when leaving
    public async ValueTask DisposeAsync()
    {
        await StopScannerAsync();
        _dotNetRef?.Dispose();
    }

    private record CameraDevice(string DeviceId, string Label);

    private string? GetPreferredCameraDeviceId()
    {
        if (_devices.Count == 0)
        {
            return null;
        }

        var preferred = _devices.FirstOrDefault(device =>
            device.Label?.Contains("back", System.StringComparison.OrdinalIgnoreCase) == true ||
            device.Label?.Contains("rear", System.StringComparison.OrdinalIgnoreCase) == true ||
            device.Label?.Contains("environment", System.StringComparison.OrdinalIgnoreCase) == true);

        return preferred?.DeviceId ?? _devices.First().DeviceId;
    }
}
