@namespace M_Wallet.Client.Components
@using M_Wallet.Shared
@using MudBlazor
@using M_Wallet.Client.Services
@using System.Net.Http.Json
@inject HttpClient Http
@inject NotificationService Notify

@* Pattern-based authorization control *@
<PatternLock @ref="patternLock" OnPatternComplete="VerifyPattern" />

@code {
    [Parameter] public EventCallback<Person> OnAuthorized { get; set; }
    
    private PatternLock? patternLock;

    // Verify drawn pattern with backend and emit authorized person
    private async Task VerifyPattern(string pattern)
    {
        try
        {
            var response = await Http.GetAsync($"api/people/verify/{pattern}");
            if (response.IsSuccessStatusCode)
            {
                var emp = await response.Content.ReadFromJsonAsync<Person>();
                if (emp != null)
                {
                    await OnAuthorized.InvokeAsync(emp);
                }
            }
            else
            {
                if (patternLock != null)
                {
                    await patternLock.ShowError("Invalid Pattern");
                }
                else
                {
                    Notify.Error("Invalid Pattern");
                }
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error: {ex.Message}");
        }
    }
}
