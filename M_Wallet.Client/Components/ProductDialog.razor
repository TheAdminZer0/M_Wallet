@using System.Security.Cryptography
@using System.Text
@inject NotificationService Notify
@inject IDialogService DialogService
@inject HttpClient Http
@inject UserPreferencesService UserPreferencesService

@* Product create/edit dialog *@
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(IsEditMode ? "Edit Product" : "Add New Product")
        </MudText>
    </TitleContent>
    <DialogContent>
        @* Basic product fields *@
        <MudGrid GutterSize="2" Class="mb-2">
            <MudItem xs="8">
                <MudTextField @bind-Value="Product.Name" 
                              Label="Product Name" 
                              Required="true" 
                              RequiredError="Name is required"
                              Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="4">
                <MudNumericField @bind-Value="Product.StockQuantity" 
                                 Label="Stock" 
                                 Min="0"
                                 Variant="Variant.Outlined"
                                 Disabled="@(Product.IsStockless || Product.IsService)" />
            </MudItem>
        </MudGrid>

        <MudTextField @bind-Value="Product.Description" 
                      Label="Description" 
                      Lines="3"
                      Variant="Variant.Outlined"
                  Class="mb-2" />

        @* Pricing inputs *@
        <MudGrid GutterSize="2" Class="mb-2">
            <MudItem xs="12" sm="6">
                <MudNumericField @bind-Value="Product.CostPrice" 
                                 Label="Cost Price (What you paid)" 
                                 Format="F2"
                                 Min="0m"
                                 Adornment="Adornment.Start" 
                                 AdornmentText="LD"
                                 Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudNumericField @bind-Value="Product.Price" 
                                 Label="Selling Price" 
                                 Format="F2"
                                 Min="0m"
                                 Adornment="Adornment.Start" 
                                 AdornmentText="LD"
                                 Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>

        @* Stockless/service toggles *@
        <MudGrid GutterSize="2" Class="mb-2">
            <MudItem xs="6">
                <MudSwitch @bind-Value="Product.IsStockless" 
                           Label="Stockless (Infinite Stock)" 
                           Color="Color.Primary" />
            </MudItem>
            <MudItem xs="6">
                <MudSwitch @bind-Value="Product.IsService" 
                           Label="Allow Cost Edit in Cart" 
                           Color="Color.Warning" />
            </MudItem>
        </MudGrid>

        @* Barcode management (generate/scan/add/remove) *@
        <MudStack Spacing="1" Class="mb-2">
            <div class="d-flex align-center gap-1">
                <MudTooltip Text="Generate Random Barcode">
                    <MudIconButton Icon="@Icons.Material.Filled.AutoFixHigh"
                                   Color="Color.Secondary"
                                   Size="Size.Medium"
                                   OnClick="GenerateBarcode" />
                </MudTooltip>

                <MudTextField @bind-Value="_currentBarcodeValue"
                              Label="Barcode / SKU"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Placeholder="Scan or type"
                              Class="flex-grow-1"
                              @onkeydown="HandleBarcodeKeyDown"
                              OnBlur="HandleBarcodeBlur" />

                <MudTooltip Text="Scan Barcode">
                    <MudIconButton Icon="@Icons.Material.Filled.QrCodeScanner"
                                   Color="Color.Primary"
                                   Size="Size.Medium"
                                   OnClick="OpenScannerDialogAsync" />
                </MudTooltip>

                <MudTooltip Text="Add Barcode">
                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                   Color="Color.Primary"
                                   Size="Size.Medium"
                                   OnClick="StartNewBarcode" />
                </MudTooltip>
            </div>
            @if (Product.Barcodes.Any())
            {
                <MudStack Direction="Row" Spacing="1" Class="flex-wrap">
                    @foreach (var barcode in Product.Barcodes)
                    {
                        <MudChip T="string"
                                 Text="@barcode.Barcode"
                                 OnClose="@(() => RemoveBarcode(barcode))"
                                 Color="Color.Primary"
                                 Variant="Variant.Outlined" />
                    }
                </MudStack>
            }
        </MudStack>

        @if (Product.CostPrice > 0 && Product.Price > 0)
        {
            var profit = Product.Price - Product.CostPrice;
            var profitMargin = (profit / Product.Price) * 100;
            <MudAlert Severity="@(profit > 0 ? Severity.Success : Severity.Warning)" Dense="true" Class="mb-2">
                Profit: LYD @profit.ToString("F2") (@profitMargin.ToString("F1")% margin)
            </MudAlert>
        }



        @* Image upload + preview *@
        <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
             <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles">
                 <ActivatorContent>
                     <MudButton Variant="Variant.Filled"
                                Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.CloudUpload">
                         Upload Image
                     </MudButton>
                 </ActivatorContent>
             </MudFileUpload>
        </MudStack>
        
        @if (!string.IsNullOrEmpty(Product.ImageUrl))
        {
            <MudPaper Class="d-flex justify-center pa-2 my-2" Outlined="true">
                <MudImage Src="@Product.ImageUrl" Height="150" ObjectFit="ObjectFit.Contain" />
            </MudPaper>
        }
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="CancelAsync">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit">
            @(IsEditMode ? "Update" : "Add")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] 
    public Product Product { get; set; } = new();

    [Parameter]
    public bool IsEditMode { get; set; } = false;

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public EventCallback<Product> OnSubmit { get; set; }

    // Validate and return product payload
    private async Task Submit()
    {
        AddCurrentBarcode();

        // Basic validation
        if (string.IsNullOrWhiteSpace(Product.Name))
        {
            Notify.Error("Product name is required");
            return;
        }

        if (Product.CostPrice < 0)
        {
            Notify.Error("Cost price cannot be negative");
            return;
        }

        if (Product.Price <= 0)
        {
            Notify.Error("Selling price must be greater than zero");
            return;
        }

        if (Product.CostPrice > Product.Price)
        {
            Notify.Warning("Warning: Selling price is lower than cost price - you will lose money!");
        }

        // Invoke the submit callback
        await OnSubmit.InvokeAsync(Product);
    }

    private async Task CancelAsync()
    {
        await OnCancel.InvokeAsync();
    }

    private string _currentBarcodeValue = string.Empty;

    // Generate random 13-digit barcode
    private void GenerateBarcode()
    {
        var builder = new StringBuilder(13);
        for (var i = 0; i < 13; i++)
        {
            builder.Append(RandomNumberGenerator.GetInt32(0, 10));
        }

        _currentBarcodeValue = builder.ToString();
    }

    // Add current barcode field into list if unique
    private void AddCurrentBarcode()
    {
        if (!string.IsNullOrWhiteSpace(_currentBarcodeValue))
        {
            var trimmed = _currentBarcodeValue.Trim();
            if (!string.IsNullOrWhiteSpace(trimmed) && !Product.Barcodes.Any(b => string.Equals(b.Barcode, trimmed, StringComparison.OrdinalIgnoreCase)))
            {
                Product.Barcodes.Add(new ProductBarcode { Barcode = trimmed });
            }
            _currentBarcodeValue = string.Empty;
        }
    }

    // Enter key adds barcode
    private void HandleBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddCurrentBarcode();
        }
    }

    // Finalize current barcode and clear input
    private void StartNewBarcode()
    {
        AddCurrentBarcode();
    }

    private void HandleBarcodeBlur(FocusEventArgs _)
    {
        AddCurrentBarcode();
    }

    // Remove a barcode chip
    private void RemoveBarcode(ProductBarcode barcode)
    {
        Product.Barcodes.Remove(barcode);
    }

    private IDialogReference? _scannerDialogReference;

    // Open camera scanner to capture barcode
    private async Task OpenScannerDialogAsync()
    {
        var parameters = new DialogParameters<BarcodeScannerDialog>
        {
            { x => x.OnDetected, EventCallback.Factory.Create<string>(this, HandleBarcodeDetectedAsync) },
            { x => x.OnCancel, EventCallback.Factory.Create(this, CloseScannerDialogAsync) }
        };

        var options = new DialogOptions
        {
            FullScreen = true,
            CloseButton = true
        };

        _scannerDialogReference = await DialogService.ShowAsync<BarcodeScannerDialog>("Scan Barcode", parameters, options);
    }

    // Scanner callback populates barcode list
    private async Task HandleBarcodeDetectedAsync(string code)
    {
        if (!string.IsNullOrWhiteSpace(code))
        {
            _currentBarcodeValue = code;
            AddCurrentBarcode();
            Notify.Success($"Barcode captured: {code}");
            StateHasChanged();
        }

        await CloseScannerDialogAsync();
    }

    private Task CloseScannerDialogAsync()
    {
        _scannerDialogReference?.Close();
        _scannerDialogReference = null;
        return Task.CompletedTask;
    }

    // Upload product image with optional client-side resize
    private async Task UploadFiles(IBrowserFile file)
    {
        if (file is null) return;

        // Ensure product name is entered first
        if (string.IsNullOrWhiteSpace(Product.Name))
        {
            Notify.Warning("Please enter the Product Name before uploading an image.");
            return;
        }

        // Limit size to 30MB for the initial file selection to prevent immediate rejection
        long maxFileSize = 1024 * 1024 * 30; 

        try
        {
            var prefs = await UserPreferencesService.LoadPreferences();
            IBrowserFile fileToUpload = file;
            string contentType = file.ContentType;
            string fileName = file.Name;

            if (prefs.EnableImageResizing)
            {
                // Resize image to max resolution from settings (default 800)
                int maxRes = prefs.MaxImageResolution > 0 ? prefs.MaxImageResolution : 800;
                
                try 
                {
                    // This significantly reduces upload size and memory usage
                    fileToUpload = await file.RequestImageFileAsync("image/jpeg", maxRes, maxRes);
                    contentType = "image/jpeg";
                    fileName = "product_image.jpg";
                }
                catch (Exception resizeEx)
                {
                    Console.WriteLine($"Resize failed: {resizeEx.Message}. Uploading original.");
                }
            }
            
            using var content = new MultipartFormDataContent();
            
            // Read the file (resized or original)
            var fileContent = new StreamContent(fileToUpload.OpenReadStream(maxFileSize));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(contentType);
            
            content.Add(fileContent, "file", fileName);
            content.Add(new StringContent(Product.Name), "productName");

            var response = await Http.PostAsync("api/Uploads", content);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<UploadResult>();
                if (result != null)
                {
                    // Add timestamp to prevent caching issues
                    Product.ImageUrl = $"{result.Url}?t={DateTime.Now.Ticks}";
                    
                    // IMMEDIATE SAVE: If product exists, save the new image URL to DB immediately
                    // This ensures the link is kept even if the app crashes afterwards
                    if (Product.Id > 0)
                    {
                        try 
                        {
                            await Http.PutAsJsonAsync($"api/products/{Product.Id}", Product);
                            Notify.Success("Image uploaded & saved");
                        }
                        catch
                        {
                            Notify.Warning("Image uploaded (Save failed)");
                        }
                    }
                    else
                    {
                        Notify.Success("Image uploaded successfully");
                    }

                    StateHasChanged();
                }
            }
            else
            {
                Notify.Error("Image upload failed");
            }
        }
        catch (Exception ex)
        {
            Notify.Error($"Error uploading image: {ex.Message}");
        }
    }

    private class UploadResult
    {
        public string Url { get; set; } = string.Empty;
    }
}