@using M_Wallet.Shared
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="model.Name" Label="Display Name" Required="true" />
        <MudTextField @bind-Value="model.Username" Label="Username" />
        <MudTextField @bind-Value="model.Password" Label="Password" InputType="InputType.Password" />
        
        @if (IsAdminMode)
        {
            <MudSelect T="string" Label="Role" @bind-Value="model.Role" Class="mt-4">
                <MudSelectItem Value="@("Staff")">Staff</MudSelectItem>
                <MudSelectItem Value="@("Admin")">Admin</MudSelectItem>
            </MudSelect>
        }

        <MudText Class="mt-4 mb-2">Set Passcode Pattern @(Employee != null ? "(Leave empty to keep current)" : "")</MudText>
        <div class="d-flex justify-center border rounded pa-4">
            <PatternLock OnPatternComplete="OnPatternEntered" />
        </div>
        @if (!string.IsNullOrEmpty(model.Passcode))
        {
            <MudText Color="Color.Success" Class="mt-2 align-center">Passcode Set!</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(string.IsNullOrEmpty(model.Name) || (Employee == null && string.IsNullOrEmpty(model.Passcode)))">
            @(Employee == null ? "Add Employee" : "Save Changes")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Employee? Employee { get; set; }
    [Parameter] public bool IsAdminMode { get; set; }

    private Employee model = new();

    protected override void OnInitialized()
    {
        if (Employee != null)
        {
            model = new Employee
            {
                Id = Employee.Id,
                Name = Employee.Name,
                Passcode = Employee.Passcode,
                Role = Employee.Role,
                IsActive = Employee.IsActive,
                Username = Employee.Username,
                Password = Employee.Password
            };
        }
    }

    private void OnPatternEntered(string pattern)
    {
        model.Passcode = pattern;
        StateHasChanged();
    }

    private async Task Submit()
    {
        try
        {
            HttpResponseMessage response;
            if (Employee == null)
            {
                response = await Http.PostAsJsonAsync("api/employees", model);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/employees/{model.Id}", model);
            }

            if (response.IsSuccessStatusCode)
            {
                MudDialog.Close(DialogResult.Ok(true));
                Snackbar.Add(Employee == null ? "Employee added" : "Employee updated", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to save employee", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
